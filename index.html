<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>مكتبة المستقبل - نظام الإدارة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg, #0d1421 0%, #1a2744 100%); min-height: 100vh; color: #fff; }
        .login-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; width: 100%; max-width: 400px; text-align: center; }
        .login-box h1 { color: #00d4ff; margin-bottom: 10px; font-size: 2rem; }
        .login-box .subtitle { color: rgba(255,255,255,0.7); margin-bottom: 30px; }
        .login-box .icon { font-size: 4rem; color: #00d4ff; margin-bottom: 20px; }
        .navbar { background: rgba(20,30,60,0.95); backdrop-filter: blur(10px); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; border-bottom: 2px solid rgba(0,212,255,0.3); }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 700; color: #00d4ff; }
        .nav-links { display: flex; gap: 5px; flex-wrap: wrap; }
        .nav-btn { background: rgba(0,100,150,0.4); border: 2px solid rgba(0,212,255,0.5); color: #fff; padding: 10px 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-family: 'Cairo', sans-serif; font-size: 0.9rem; font-weight: 600; }
        .nav-btn:hover, .nav-btn.active { background: #00d4ff; color: #1a1a2e; border-color: #00d4ff; }
        .user-info { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 10px; }
        .user-info .user-name { color: #00ff88; font-weight: 600; }
        .user-info .user-role { color: rgba(255,255,255,0.6); font-size: 0.8rem; }
        .logout-btn { background: rgba(255,71,87,0.3); border: none; color: #ff4757; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-family: 'Cairo', sans-serif; transition: all 0.3s; }
        .logout-btn:hover { background: #ff4757; color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .card { background: rgba(20,35,65,0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(0,212,255,0.2); }
        .card-title { font-size: 1.3rem; margin-bottom: 20px; color: #00d4ff; display: flex; align-items: center; gap: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, rgba(0,100,150,0.5), rgba(0,50,100,0.3)); border-radius: 15px; padding: 20px; text-align: center; border: 2px solid rgba(0,212,255,0.4); }
        .stat-icon { font-size: 2.5rem; margin-bottom: 10px; color: #00d4ff; }
        .stat-value { font-size: 2rem; font-weight: 700; color: #fff; }
        .stat-label { color: rgba(255,255,255,0.7); font-size: 0.9rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: rgba(255,255,255,0.8); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; background: rgba(255,255,255,0.05); color: #fff; font-family: 'Cairo', sans-serif; font-size: 1rem; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus { border-color: #00d4ff; outline: none; }
        .form-group select option { background: #1a1a2e; color: #fff; }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 1rem; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #0099cc); color: #1a1a2e; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,212,255,0.4); }
        .btn-success { background: linear-gradient(135deg, #00ff88, #00cc6a); color: #1a1a2e; }
        .btn-danger { background: linear-gradient(135deg, #ff4757, #cc3344); color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.2); color: #fff; }
        .btn-full { width: 100%; justify-content: center; }
        .btn-warning { background: linear-gradient(135deg, #ffaa00, #ff8800); color: #1a1a2e; }
        .services-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .service-card { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .service-card:hover { border-color: #00d4ff; transform: translateY(-3px); }
        .service-card.selected { border-color: #00ff88; background: rgba(0,255,136,0.1); }
        .service-card i { font-size: 2rem; margin-bottom: 10px; color: #00d4ff; }
        .service-card h4 { font-size: 0.95rem; margin-bottom: 5px; }
        .service-card .price { color: #00ff88; font-weight: 700; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid rgba(0,212,255,0.2); color: #fff; }
        th { background: rgba(0,100,150,0.5); color: #00d4ff; font-weight: 700; }
        tr:hover { background: rgba(0,212,255,0.1); }
        .order-summary { background: rgba(0,212,255,0.1); border-radius: 15px; padding: 20px; margin-top: 20px; }
        .order-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .order-total { display: flex; justify-content: space-between; padding: 15px 0; font-size: 1.3rem; font-weight: 700; color: #00ff88; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: rgba(0,100,150,0.3); border: 2px solid rgba(0,212,255,0.4); border-radius: 10px; color: #fff; cursor: pointer; font-family: 'Cairo', sans-serif; transition: all 0.3s; font-weight: 600; }
        .tab:hover { background: rgba(0,212,255,0.3); }
        .tab.active { background: #00d4ff; color: #1a1a2e; border-color: #00d4ff; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #1a1a2e; border-radius: 20px; padding: 30px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        .setup-section { text-align: center; padding: 50px 20px; }
        .setup-section h2 { margin-bottom: 20px; color: #00d4ff; }
        .setup-section p { margin-bottom: 30px; color: rgba(255,255,255,0.7); }
        .setup-input { max-width: 500px; margin: 0 auto 20px; }
        .alert { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .alert-success { background: rgba(0,255,136,0.2); border: 1px solid #00ff88; color: #00ff88; }
        .alert-error { background: rgba(255,71,87,0.2); border: 1px solid #ff4757; color: #ff4757; }
        .alert-info { background: rgba(0,212,255,0.2); border: 1px solid #00d4ff; color: #00d4ff; }
        .alert-warning { background: rgba(255,170,0,0.2); border: 1px solid #ffaa00; color: #ffaa00; }
        @media print { body { background: #fff; color: #000; } .navbar, .nav-links, .btn, .no-print { display: none !important; } .card { background: #fff; border: 1px solid #ddd; } }
        @media (max-width: 768px) { .navbar { flex-direction: column; } .nav-links { width: 100%; justify-content: center; } .nav-btn { padding: 8px 12px; font-size: 0.8rem; } }
        .section { display: none !important; }
        .section.active { display: block !important; }
        .invoice { background: #fff; color: #000; padding: 30px; border-radius: 10px; }
        .invoice-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
        .invoice table { width: 100%; margin: 20px 0; }
        .invoice th, .invoice td { border: 1px solid #ddd; padding: 10px; color: #000; }
        .invoice th { background: #f5f5f5; color: #000; }
        .quantity-control { display: flex; align-items: center; gap: 10px; }
        .quantity-btn { width: 35px; height: 35px; border: none; border-radius: 8px; background: #00d4ff; color: #1a1a2e; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .quantity-input { width: 120px; text-align: center; font-size: 1.2rem; font-weight: 600; padding: 10px !important; }
        .role-badge { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; }
        .role-admin { background: rgba(0,212,255,0.3); color: #00d4ff; }
        .role-accountant { background: rgba(255,170,0,0.3); color: #ffaa00; }
        .admin-only { display: block; }
        body.accountant-mode .admin-only { display: none !important; }
        .accountant-only { display: none; }
        body.accountant-mode .accountant-only { display: block !important; }
        .expense-card { background: rgba(255,170,0,0.1); border: 1px solid rgba(255,170,0,0.3); }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <i class="fas fa-print icon"></i>
            <h1>نظام الطباعة</h1>
            <p class="subtitle">سجل الدخول للمتابعة</p>
            <div class="form-group">
                <label>اسم المستخدم</label>
                <input type="text" id="loginUsername" placeholder="أدخل اسم المستخدم">
            </div>
            <div class="form-group">
                <label>كلمة المرور</label>
                <input type="password" id="loginPassword" placeholder="أدخل كلمة المرور" onkeypress="if(event.key==='Enter') login()">
            </div>
            <button class="btn btn-primary btn-full" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
            </button>
            <div id="loginError" class="alert alert-error" style="display: none; margin-top: 20px;">
                <i class="fas fa-times-circle"></i>
                <span>اسم المستخدم أو كلمة المرور غير صحيحة</span>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <nav class="navbar">
            <div class="logo"><i class="fas fa-print"></i><span>نظام الطباعة</span></div>
            <div class="nav-links" id="navLinks">
                <button class="nav-btn active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> الرئيسية</button>
                <button class="nav-btn" onclick="showSection('newOrder')"><i class="fas fa-plus"></i> طلب جديد</button>
                <button class="nav-btn" onclick="showSection('orders')"><i class="fas fa-list"></i> الطلبات</button>
                <button class="nav-btn" onclick="showSection('expenses')"><i class="fas fa-wallet"></i> المصروفات</button>
                <button class="nav-btn admin-only" onclick="showSection('deposits')"><i class="fas fa-piggy-bank"></i> الإيداعات</button>
                <button class="nav-btn" onclick="showSection('customers')"><i class="fas fa-users"></i> العملاء</button>
                <button class="nav-btn" onclick="showSection('inventory')"><i class="fas fa-boxes"></i> المخزون</button>
                <button class="nav-btn admin-only" onclick="showSection('reports')"><i class="fas fa-chart-bar"></i> التقارير</button>
                <button class="nav-btn admin-only" onclick="showSection('settings')"><i class="fas fa-cog"></i> الإعدادات</button>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <div class="user-info">
                    <i class="fas fa-user-circle" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="user-name" id="currentUserName">المدير</div>
                        <div class="user-role" id="currentUserRole">مدير</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</button>
            </div>
        </nav>

        <div class="container">
            <!-- Setup Section -->
            <div id="setupSection" class="section">
                <div class="card">
                    <div class="setup-section">
                        <i class="fas fa-link" style="font-size: 4rem; color: #00d4ff; margin-bottom: 20px;"></i>
                        <h2>ربط النظام مع Google Sheets</h2>
                        <p>أدخل رابط الـ Web App لحفظ البيانات في Google Sheets:</p>
                        <div class="setup-input">
                            <div class="form-group">
                                <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/...../exec">
                            </div>
                            <button class="btn btn-primary" onclick="saveWebAppUrl()">
                                <i class="fas fa-save"></i> حفظ وبدء الاستخدام
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="section">
                <div class="stats-grid">
                    <div class="stat-card admin-only">
                        <i class="fas fa-money-bill-wave stat-icon"></i>
                        <div class="stat-value" id="todaySales">0</div>
                        <div class="stat-label">إجمالي مبيعات اليوم (جنيه)</div>
                    </div>
                    <div class="stat-card admin-only" style="border-color: rgba(255,170,0,0.3);">
                        <i class="fas fa-tags stat-icon" style="color: #ffaa00;"></i>
                        <div class="stat-value" id="todayDiscount" style="color: #ffaa00;">0</div>
                        <div class="stat-label">خصومات اليوم (جنيه)</div>
                    </div>
                    <div class="stat-card admin-only" style="border-color: rgba(0,255,136,0.3);">
                        <i class="fas fa-hand-holding-usd stat-icon" style="color: #00ff88;"></i>
                        <div class="stat-value" id="todayNetSales" style="color: #00ff88;">0</div>
                        <div class="stat-label">صافي مبيعات اليوم (جنيه)</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-receipt stat-icon"></i>
                        <div class="stat-value" id="todayOrders">0</div>
                        <div class="stat-label">طلبات اليوم</div>
                    </div>
                    <div class="stat-card accountant-only" style="border-color: rgba(0,212,255,0.3);">
                        <i class="fas fa-cash-register stat-icon" style="color: #00d4ff;"></i>
                        <div class="stat-value" id="accountantTodaySales" style="color: #00d4ff;">0</div>
                        <div class="stat-label">إجمالي مبيعات اليوم (جنيه)</div>
                    </div>
                    <div class="stat-card" style="border-color: rgba(255,170,0,0.3);">
                        <i class="fas fa-wallet stat-icon" style="color: #ffaa00;"></i>
                        <div class="stat-value" id="todayExpenses" style="color: #ffaa00;">0</div>
                        <div class="stat-label">مصروفات اليوم (جنيه)</div>
                    </div>
                    <div class="stat-card accountant-only" style="border-color: rgba(0,255,136,0.3);">
                        <i class="fas fa-piggy-bank stat-icon" style="color: #00ff88;"></i>
                        <div class="stat-value" id="amountToDeposit" style="color: #00ff88;">0</div>
                        <div class="stat-label">المطلوب توريده (جنيه)</div>
                    </div>
                    <div class="stat-card admin-only">
                        <i class="fas fa-calendar-alt stat-icon"></i>
                        <div class="stat-value" id="monthSales">0</div>
                        <div class="stat-label">مبيعات الشهر (جنيه)</div>
                    </div>
                </div>
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <h3 class="card-title" style="margin: 0;"><i class="fas fa-clock"></i> آخر الطلبات</h3>
                        <div class="admin-only" style="display: flex; gap: 10px; align-items: center;">
                            <select id="dashboardFilterType" onchange="updateDashboardFilter()" style="padding: 10px; border-radius: 10px; background: #16213e; color: #fff; border: 1px solid #0f3460;">
                                <option value="today">طلبات اليوم</option>
                                <option value="day">تحديد يوم</option>
                                <option value="all">عرض الكل</option>
                            </select>
                            <input type="date" id="dashboardFilterDate" onchange="loadDashboard()" style="padding: 10px; border-radius: 10px; background: #16213e; color: #fff; border: 1px solid #0f3460; display: none;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>رقم الطلب</th><th>العميل</th><th>الخدمة</th><th class="admin-only">المبلغ</th><th>التاريخ</th><th>الحالة</th><th class="admin-only">إجراء</th></tr></thead>
                            <tbody id="recentOrdersTable"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> تنبيهات المخزون</h3>
                    <div id="inventoryAlerts"></div>
                </div>
            </div>

            <!-- New Order -->
            <div id="newOrder" class="section">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-plus-circle"></i> إنشاء طلب جديد</h3>
                    <div class="form-group">
                        <label>اختر العميل أو أدخل اسم جديد</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="customerSelect" style="flex: 1;" onchange="handleCustomerSelect()">
                                <option value="">-- اختر عميل --</option>
                                <option value="new">+ عميل جديد</option>
                            </select>
                            <input type="text" id="newCustomerName" placeholder="اسم العميل الجديد" style="flex: 1; display: none;">
                            <input type="text" id="newCustomerPhone" placeholder="رقم الهاتف" style="flex: 1; display: none;">
                        </div>
                    </div>
                    <h4 style="margin: 20px 0 15px; color: #00d4ff;">اختر الخدمات:</h4>
                    <div class="services-grid" id="servicesGrid"></div>
                    <div id="selectedServicesContainer" style="display: none;">
                        <h4 style="margin: 20px 0 15px; color: #00d4ff;">تفاصيل الخدمات المختارة:</h4>
                        <div id="selectedServicesList"></div>
                    </div>
                    <div class="order-summary" id="orderSummary" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: #00d4ff;">ملخص الطلب</h4>
                        <div id="orderItems"></div>
                        <div class="order-total"><span>الإجمالي:</span><span id="orderTotal">0 جنيه</span></div>
                        <div class="form-grid" style="margin: 15px 0;">
                            <div class="form-group">
                                <label>قيمة الخصم (جنيه)</label>
                                <input type="number" id="discountAmount" value="0" min="0" step="0.5" onchange="updateOrderSummary()">
                            </div>
                            <div class="form-group">
                                <label>طريقة الدفع</label>
                                <select id="paymentMethod">
                                    <option value="نقدي">نقدي</option>
                                    <option value="بنكك">بنكك (تحويل)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>اسم الموظف</label>
                                <select id="employeeName">
                                    <option value="">-- اختر الموظف --</option>
                                </select>
                            </div>
                        </div>
                        <div class="order-total" style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 10px;"><span>الصافي المطلوب:</span><span id="orderTotalAfterDiscount" style="color: #00ff88; font-size: 1.5rem;">0 جنيه</span></div>
                        <div class="form-group"><label>ملاحظات</label><textarea id="orderNotes" rows="2" placeholder="أي ملاحظات إضافية..."></textarea></div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="saveOrder()"><i class="fas fa-save"></i> حفظ الطلب</button>
                            <button class="btn btn-primary" onclick="saveAndPrintOrder()"><i class="fas fa-print"></i> حفظ وطباعة الفاتورة</button>
                            <button class="btn btn-secondary" onclick="clearOrder()"><i class="fas fa-times"></i> إلغاء</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders List -->
            <div id="orders" class="section">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-list-alt"></i> قائمة الطلبات</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>رقم الطلب</th><th>العميل</th><th>الخدمات</th><th>المبلغ</th><th>الخصم</th><th>الصافي</th><th>الدفع</th><th>التاريخ</th><th>الحالة</th><th>إجراءات</th></tr></thead>
                            <tbody id="ordersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expenses Section -->
            <div id="expenses" class="section">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <h3 class="card-title" style="margin: 0;"><i class="fas fa-wallet"></i> المصروفات اليومية</h3>
                        <button class="btn btn-warning" onclick="showAddExpenseModal()"><i class="fas fa-plus"></i> إضافة مصروف</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card expense-card">
                            <i class="fas fa-calendar-day stat-icon" style="color: #ffaa00;"></i>
                            <div class="stat-value" id="expensesToday" style="color: #ffaa00;">0</div>
                            <div class="stat-label">مصروفات اليوم</div>
                        </div>
                        <div class="stat-card expense-card admin-only">
                            <i class="fas fa-calendar-alt stat-icon" style="color: #ffaa00;"></i>
                            <div class="stat-value" id="expensesMonth" style="color: #ffaa00;">0</div>
                            <div class="stat-label">مصروفات الشهر</div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>التاريخ</th><th>الوصف</th><th>الفئة</th><th>المبلغ</th><th>بواسطة</th><th>إجراءات</th></tr></thead>
                            <tbody id="expensesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Deposits -->
            <div id="deposits" class="section">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <h3 class="card-title" style="margin: 0;"><i class="fas fa-piggy-bank"></i> الإيداعات البنكية</h3>
                        <button class="btn btn-primary" onclick="showAddDepositModal()"><i class="fas fa-plus"></i> إضافة إيداع</button>
                    </div>
                    <!-- فلتر التاريخ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                        <select id="depositFilterType" onchange="updateDepositFilter()" style="padding: 10px; border-radius: 10px; background: #16213e; color: #fff; border: 1px solid #0f3460;">
                            <option value="day">تصفية باليوم</option>
                            <option value="month">تصفية بالشهر</option>
                            <option value="all">عرض الكل</option>
                        </select>
                        <input type="date" id="depositFilterDate" onchange="loadDeposits()" style="padding: 10px; border-radius: 10px; background: #16213e; color: #fff; border: 1px solid #0f3460;">
                        <input type="month" id="depositFilterMonth" onchange="loadDeposits()" style="padding: 10px; border-radius: 10px; background: #16213e; color: #fff; border: 1px solid #0f3460; display: none;">
                    </div>
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card"><i class="fas fa-filter stat-icon" style="color: #00d4ff;"></i><div class="stat-value" style="color: #00d4ff;" id="filteredDeposits">0.00</div><div class="stat-label">المبلغ المحدد</div></div>
                        <div class="stat-card"><i class="fas fa-calendar-alt stat-icon" style="color: #00ff88;"></i><div class="stat-value" style="color: #00ff88;" id="monthDeposits">0.00</div><div class="stat-label">إيداعات الشهر</div></div>
                        <div class="stat-card"><i class="fas fa-coins stat-icon" style="color: #ffaa00;"></i><div class="stat-value" style="color: #ffaa00;" id="totalDeposits">0.00</div><div class="stat-label">إجمالي الإيداعات</div></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>التاريخ</th><th>المبلغ</th><th>البنك/الحساب</th><th>الوصف</th><th>بواسطة</th><th>إجراءات</th></tr></thead>
                            <tbody id="depositsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customers -->
            <div id="customers" class="section">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <h3 class="card-title" style="margin: 0;"><i class="fas fa-users"></i> العملاء</h3>
                        <button class="btn btn-primary" onclick="showAddCustomerModal()"><i class="fas fa-plus"></i> إضافة عميل</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>الاسم</th><th>الهاتف</th><th>عدد الطلبات</th><th class="admin-only">إجمالي المشتريات</th><th>آخر زيارة</th><th>إجراءات</th></tr></thead>
                            <tbody id="customersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inventory -->
            <div id="inventory" class="section">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <h3 class="card-title" style="margin: 0;"><i class="fas fa-boxes"></i> المخزون</h3>
                        <button class="btn btn-primary" onclick="showAddInventoryModal()"><i class="fas fa-plus"></i> إضافة صنف</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>الصنف</th><th>الكمية الحالية</th><th>الحد الأدنى</th><th>الوحدة</th><th>الحالة</th><th>إجراءات</th></tr></thead>
                            <tbody id="inventoryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports (Admin Only) -->
            <div id="reports" class="section admin-only">
                <div class="tabs">
                    <button class="tab active" onclick="showReportTab('daily')">التقرير اليومي</button>
                    <button class="tab" onclick="showReportTab('monthly')">التقرير الشهري</button>
                    <button class="tab" onclick="showReportTab('services')">تقرير الخدمات</button>
                </div>
                <div id="dailyReport" class="card">
                    <h3 class="card-title"><i class="fas fa-calendar-day"></i> التقرير اليومي</h3>
                    <div class="form-group no-print"><label>اختر التاريخ</label><input type="date" id="dailyReportDate" onchange="loadDailyReport()"></div>
                    <div id="dailyReportContent"></div>
                </div>
                <div id="monthlyReport" class="card" style="display: none;">
                    <h3 class="card-title"><i class="fas fa-calendar-alt"></i> التقرير الشهري</h3>
                    <div id="monthlyReportContent"></div>
                </div>
                <div id="servicesReport" class="card" style="display: none;">
                    <h3 class="card-title"><i class="fas fa-chart-pie"></i> تقرير الخدمات</h3>
                    <div id="servicesReportContent"></div>
                </div>
            </div>

            <!-- Settings (Admin Only) -->
            <div id="settings" class="section admin-only">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-store"></i> معلومات المحل</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>اسم المحل</label><input type="text" id="shopName" placeholder="مركز الطباعة"></div>
                        <div class="form-group"><label>رقم الهاتف</label><input type="text" id="shopPhone" placeholder="05xxxxxxxx"></div>
                        <div class="form-group"><label>العنوان</label><input type="text" id="shopAddress" placeholder="الخرطوم - حي ..."></div>
                        <div class="form-group"><label>الرقم الضريبي (اختياري)</label><input type="text" id="shopTaxNumber"></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveShopInfo()"><i class="fas fa-save"></i> حفظ المعلومات</button>
                </div>
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-users-cog"></i> إدارة المستخدمين</h3>
                    <div class="table-container">
                        <table><thead><tr><th>اسم المستخدم</th><th>الاسم</th><th>الصلاحية</th><th>إجراءات</th></tr></thead><tbody id="usersTable"></tbody></table>
                    </div>
                    <button class="btn btn-primary" onclick="showAddUserModal()" style="margin-top: 15px;"><i class="fas fa-plus"></i> إضافة مستخدم جديد</button>
                </div>
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-user-tie"></i> إدارة الموظفين</h3>
                    <div id="employeesSettings"></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <input type="text" id="newEmployeeName" placeholder="اسم الموظف الجديد..." style="flex: 1; min-width: 200px;">
                        <button class="btn btn-primary" onclick="addEmployee()"><i class="fas fa-plus"></i> إضافة موظف</button>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-calendar-check"></i> المصروفات الثابتة الشهرية</h3>
                    <div id="fixedExpensesSettings"></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; align-items: end;">
                        <div class="form-group" style="flex: 2; min-width: 150px; margin: 0;">
                            <label>اسم المصروف</label>
                            <input type="text" id="newFixedExpenseName" placeholder="مثال: إيجار، كهرباء...">
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 100px; margin: 0;">
                            <label>المبلغ (جنيه)</label>
                            <input type="number" id="newFixedExpenseAmount" step="0.5" placeholder="0">
                        </div>
                        <button class="btn btn-warning" onclick="addFixedExpense()" style="height: 45px;"><i class="fas fa-plus"></i> إضافة</button>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-list"></i> إدارة الخدمات والأسعار</h3>
                    <div id="servicesSettings"></div>
                    <button class="btn btn-primary" onclick="showAddServiceModal()" style="margin-top: 15px;"><i class="fas fa-plus"></i> إضافة خدمة جديدة</button>
                    <button class="btn btn-success" onclick="syncServicesToCloud()" style="margin-top: 15px; margin-right: 10px;"><i class="fas fa-cloud-upload-alt"></i> حفظ في Google Sheets</button>
                </div>
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-link"></i> رابط Google Sheets</h3>
                    <div class="form-group"><input type="text" id="currentWebAppUrl" readonly></div>
                    <button class="btn btn-secondary" onclick="changeWebAppUrl()"><i class="fas fa-edit"></i> تغيير الرابط</button>
                </div>
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-database"></i> إدارة البيانات</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportData()"><i class="fas fa-download"></i> تصدير البيانات</button>
                        <button class="btn btn-danger" onclick="confirmClearData()"><i class="fas fa-trash"></i> مسح جميع البيانات</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3><i class="fas fa-wallet"></i> إضافة مصروف جديد</h3><button class="modal-close" onclick="closeModal('addExpenseModal')">&times;</button></div>
            <div class="form-group"><label>وصف المصروف *</label><input type="text" id="modalExpenseDesc" placeholder="مثال: شراء ورق" required></div>
            <div class="form-group"><label>المبلغ (جنيه) *</label><input type="number" id="modalExpenseAmount" step="0.5" required></div>
            <div class="form-group"><label>الفئة</label>
                <select id="modalExpenseCategory">
                    <option value="مستلزمات">مستلزمات (ورق، حبر، إلخ)</option>
                    <option value="إيجار">إيجار</option>
                    <option value="كهرباء">كهرباء</option>
                    <option value="رواتب">رواتب</option>
                    <option value="صيانة">صيانة</option>
                    <option value="نقل">نقل ومواصلات</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>
            <div class="form-group"><label>ملاحظات</label><textarea id="modalExpenseNotes" rows="2"></textarea></div>
            <button class="btn btn-warning" onclick="addExpense()"><i class="fas fa-save"></i> حفظ المصروف</button>
        </div>
    </div>

    <div id="addDepositModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3><i class="fas fa-piggy-bank"></i> إضافة إيداع جديد</h3><button class="modal-close" onclick="closeModal('addDepositModal')">&times;</button></div>
            <div class="form-group"><label>تاريخ الإيداع *</label><input type="date" id="modalDepositDate" required></div>
            <div class="form-group"><label>المبلغ (جنيه) *</label><input type="number" id="modalDepositAmount" step="0.5" required></div>
            <div class="form-group"><label>البنك/الحساب *</label>
                <select id="modalDepositBank">
                    <option value="بنكك">بنكك</option>
                    <option value="بنك الخرطوم">بنك الخرطوم</option>
                    <option value="بنك فيصل">بنك فيصل</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>
            <div class="form-group"><label>وصف/ملاحظات</label><input type="text" id="modalDepositDesc" placeholder="مثال: إيداع مبيعات الأسبوع"></div>
            <button class="btn btn-primary" onclick="addDeposit()"><i class="fas fa-save"></i> حفظ الإيداع</button>
        </div>
    </div>

    <div id="addCustomerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3><i class="fas fa-user-plus"></i> إضافة عميل جديد</h3><button class="modal-close" onclick="closeModal('addCustomerModal')">&times;</button></div>
            <div class="form-group"><label>اسم العميل *</label><input type="text" id="modalCustomerName" required></div>
            <div class="form-group"><label>رقم الهاتف</label><input type="text" id="modalCustomerPhone"></div>
            <div class="form-group"><label>البريد الإلكتروني</label><input type="email" id="modalCustomerEmail"></div>
            <div class="form-group"><label>ملاحظات</label><textarea id="modalCustomerNotes" rows="2"></textarea></div>
            <button class="btn btn-primary" onclick="addCustomer()"><i class="fas fa-save"></i> حفظ</button>
        </div>
    </div>

    <div id="addServiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3><i class="fas fa-plus-circle"></i> إضافة خدمة</h3><button class="modal-close" onclick="closeModal('addServiceModal')">&times;</button></div>
            <div class="form-group"><label>اسم الخدمة *</label><input type="text" id="modalServiceName" required></div>
            <div class="form-group"><label>السعر (جنيه) *</label><input type="number" id="modalServicePrice" step="0.5" required></div>
            <div class="form-group"><label>الأيقونة</label><select id="modalServiceIcon">
<optgroup label="الطباعة والنسخ">
<option value="fa-print">طابعة</option>
<option value="fa-copy">نسخ</option>
<option value="fa-file-alt">ملف</option>
<option value="fa-file-pdf">PDF</option>
<option value="fa-file-word">وورد</option>
<option value="fa-file-excel">إكسل</option>
</optgroup>
<optgroup label="التصميم والصور">
<option value="fa-palette">ألوان</option>
<option value="fa-image">صورة</option>
<option value="fa-camera">كاميرا</option>
<option value="fa-paint-brush">فرشاة</option>
<option value="fa-pen-fancy">قلم فني</option>
<option value="fa-crop">قص</option>
</optgroup>
<optgroup label="الكمبيوتر وملحقاته">
<option value="fa-laptop">لابتوب</option>
<option value="fa-desktop">كمبيوتر</option>
<option value="fa-keyboard">كيبورد</option>
<option value="fa-mouse">ماوس</option>
<option value="fa-headphones">سماعات</option>
<option value="fa-usb">USB</option>
<option value="fa-hdd">هارد دسك</option>
<option value="fa-memory">رام</option>
<option value="fa-microchip">معالج</option>
<option value="fa-ethernet">كيبل شبكة</option>
<option value="fa-wifi">واي فاي</option>
<option value="fa-plug">شاحن/محول</option>
</optgroup>
<optgroup label="الموبايل وملحقاته">
<option value="fa-mobile-alt">موبايل</option>
<option value="fa-tablet-alt">تابلت</option>
<option value="fa-sim-card">شريحة</option>
<option value="fa-battery-full">بطارية</option>
<option value="fa-charging-station">شاحن</option>
<option value="fa-volume-up">سماعة موبايل</option>
<option value="fa-shield-alt">جراب/حماية</option>
</optgroup>
<optgroup label="الأدوات المكتبية">
<option value="fa-pen">قلم</option>
<option value="fa-pencil-alt">قلم رصاص</option>
<option value="fa-eraser">ممحاة</option>
<option value="fa-ruler">مسطرة</option>
<option value="fa-scissors">مقص</option>
<option value="fa-paperclip">مشبك ورق</option>
<option value="fa-thumbtack">دبوس</option>
<option value="fa-sticky-note">ملاحظات لاصقة</option>
<option value="fa-folder">مجلد</option>
<option value="fa-folder-open">ملف مفتوح</option>
<option value="fa-archive">أرشيف</option>
<option value="fa-box">صندوق</option>
<option value="fa-tape">شريط لاصق</option>
<option value="fa-calculator">آلة حاسبة</option>
<option value="fa-stamp">ختم</option>
</optgroup>
<optgroup label="الكتب والتعليم">
<option value="fa-book">كتاب</option>
<option value="fa-book-open">كتاب مفتوح</option>
<option value="fa-bookmark">علامة كتاب</option>
<option value="fa-graduation-cap">تخرج</option>
<option value="fa-chalkboard">سبورة</option>
<option value="fa-globe">كرة أرضية</option>
</optgroup>
<optgroup label="الصيانة والإصلاح">
<option value="fa-tools">أدوات</option>
<option value="fa-wrench">مفتاح</option>
<option value="fa-screwdriver">مفك</option>
<option value="fa-cog">ترس</option>
<option value="fa-cogs">تروس</option>
<option value="fa-hammer">مطرقة</option>
</optgroup>
<optgroup label="أخرى">
<option value="fa-gift">هدية</option>
<option value="fa-shopping-bag">حقيبة تسوق</option>
<option value="fa-shopping-cart">عربة تسوق</option>
<option value="fa-tag">تاج سعر</option>
<option value="fa-tags">تاجات</option>
<option value="fa-barcode">باركود</option>
<option value="fa-qrcode">QR كود</option>
<option value="fa-star">نجمة</option>
<option value="fa-heart">قلب</option>
<option value="fa-lightbulb">مصباح</option>
<option value="fa-clock">ساعة</option>
<option value="fa-calendar">تقويم</option>
</optgroup>
</select></div>
            <div class="form-group"><label><input type="checkbox" id="modalServiceHasDiscount"> خصم للكميات الكبيرة</label></div>
            <div id="discountSettings" style="display: none;">
                <div class="form-group"><label>الكمية للخصم</label><input type="number" id="modalDiscountQty" value="100"></div>
                <div class="form-group"><label>نسبة الخصم (%)</label><input type="number" id="modalDiscountPercent" value="10"></div>
            </div>
            <div class="form-group"><label><input type="checkbox" id="modalServiceHasCommission"> نسبة للموظف</label></div>
            <div id="commissionSettings" style="display: none;">
                <div class="form-group"><label>نسبة العمولة (%)</label><input type="number" id="modalCommissionPercent" value="5" min="0" max="100"></div>
            </div>
            <button class="btn btn-primary" onclick="addService()"><i class="fas fa-save"></i> حفظ</button>
        </div>
    </div>

    <div id="editServiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3><i class="fas fa-edit"></i> تعديل الخدمة</h3><button class="modal-close" onclick="closeModal('editServiceModal')">&times;</button></div>
            <input type="hidden" id="editServiceId">
            <div class="form-group"><label>اسم الخدمة *</label><input type="text" id="editServiceName" required></div>
            <div class="form-group"><label>السعر (جنيه) *</label><input type="number" id="editServicePrice" step="0.5" required></div>
            <div class="form-group"><label><input type="checkbox" id="editServiceHasDiscount"> خصم للكميات الكبيرة</label></div>
            <div id="editDiscountSettings" style="display: none;">
                <div class="form-group"><label>الكمية للخصم</label><input type="number" id="editDiscountQty" value="100"></div>
                <div class="form-group"><label>نسبة الخصم (%)</label><input type="number" id="editDiscountPercent" value="10"></div>
            </div>
            <div class="form-group"><label><input type="checkbox" id="editServiceHasCommission"> نسبة للموظف</label></div>
            <div id="editCommissionSettings" style="display: none;">
                <div class="form-group"><label>نسبة العمولة (%)</label><input type="number" id="editCommissionPercent" value="5" min="0" max="100"></div>
            </div>
            <button class="btn btn-primary" onclick="saveServiceEdit()"><i class="fas fa-save"></i> حفظ التعديلات</button>
        </div>
    </div>

    <div id="addInventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3><i class="fas fa-box"></i> إضافة صنف للمخزون</h3><button class="modal-close" onclick="closeModal('addInventoryModal')">&times;</button></div>
            <div class="form-group"><label>اسم الصنف *</label><input type="text" id="modalItemName" required></div>
            <div class="form-group"><label>الكمية الحالية *</label><input type="number" id="modalItemQty" required></div>
            <div class="form-group"><label>الحد الأدنى للتنبيه *</label><input type="number" id="modalItemMinQty" required></div>
            <div class="form-group"><label>الوحدة</label><select id="modalItemUnit"><option value="رزمة">رزمة</option><option value="علبة">علبة</option><option value="قطعة">قطعة</option></select></div>
            <button class="btn btn-primary" onclick="addInventoryItem()"><i class="fas fa-save"></i> حفظ</button>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3><i class="fas fa-user-plus"></i> إضافة مستخدم جديد</h3><button class="modal-close" onclick="closeModal('addUserModal')">&times;</button></div>
            <div class="form-group"><label>اسم المستخدم *</label><input type="text" id="modalUsername" required></div>
            <div class="form-group"><label>الاسم الكامل *</label><input type="text" id="modalUserFullName" required></div>
            <div class="form-group"><label>كلمة المرور *</label><input type="password" id="modalUserPassword" required></div>
            <div class="form-group"><label>الصلاحية *</label><select id="modalUserRole"><option value="admin">مدير (صلاحية كاملة)</option><option value="accountant">محاسب (بدون الإيرادات)</option></select></div>
            <button class="btn btn-primary" onclick="addUser()"><i class="fas fa-save"></i> حفظ</button>
        </div>
    </div>

    <div id="invoiceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header no-print"><h3><i class="fas fa-file-invoice"></i> الفاتورة</h3><button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button></div>
            <div id="invoiceContent"></div>
            <div class="no-print" style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="printInvoice()"><i class="fas fa-print"></i> طباعة</button>
                <button class="btn btn-secondary" onclick="closeModal('invoiceModal')"><i class="fas fa-times"></i> إغلاق</button>
            </div>
        </div>
    </div>

    <script>
        // ============ Configuration ============
        const DEFAULT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwJDO3pLTE-B3UAP39Njq5i6yJwRPrQySifD3Ta6KyCyioL5DZzYaeTLwfbMqZPOl5K5Q/exec';
        // Force update: Clear old URL and use new one
        localStorage.setItem('webAppUrl_mustaqbal', DEFAULT_WEB_APP_URL);
        let WEB_APP_URL = DEFAULT_WEB_APP_URL;
        let currentUser = null;

        // المستخدمون الآن من Google Sheets فقط
        // شيت Users: رقم المستخدم | اسم المستخدم | كلمة المرور | الاسم الكامل | الصلاحية

        const defaultServices = [
            { id: 1, name: 'طباعة أبيض وأسود', price: 5, icon: 'fa-print', hasDiscount: true, discountQty: 100, discountPercent: 10, hasCommission: true, commissionPercent: 5 },
            { id: 2, name: 'طباعة ألوان', price: 15, icon: 'fa-palette', hasDiscount: true, discountQty: 50, discountPercent: 15, hasCommission: true, commissionPercent: 5 },
            { id: 3, name: 'تصوير/نسخ', price: 3, icon: 'fa-copy', hasDiscount: true, discountQty: 100, discountPercent: 10, hasCommission: true, commissionPercent: 5 },
            { id: 4, name: 'سكان', price: 10, icon: 'fa-scanner', hasDiscount: false, hasCommission: false, commissionPercent: 0 },
            { id: 5, name: 'تجليد حراري', price: 50, icon: 'fa-book', hasDiscount: false, hasCommission: false, commissionPercent: 0 },
            { id: 6, name: 'تجليد سلك', price: 75, icon: 'fa-book', hasDiscount: false, hasCommission: false, commissionPercent: 0 },
            { id: 7, name: 'طباعة صور 4x6', price: 25, icon: 'fa-image', hasDiscount: true, discountQty: 10, discountPercent: 20, hasCommission: false, commissionPercent: 0 },
            { id: 8, name: 'طباعة صور 10x15', price: 50, icon: 'fa-image', hasDiscount: false, hasCommission: false, commissionPercent: 0 },
            { id: 9, name: 'تغليف حراري', price: 30, icon: 'fa-id-card', hasDiscount: false, hasCommission: false, commissionPercent: 0 },
        ];

        // Calculate employee commission from orders - grouped by employee
        // دالة تنسيق الأرقام بفواصل الآلاف
        function formatNumber(num) {
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calculateCommission(orders) {
            const employeeCommissions = {};
            let totalCommission = 0;
            orders.forEach(order => {
                if (!order.items) return;
                const empName = order.employeeName || 'غير محدد';

                // حساب إجمالي الفاتورة قبل الخصم الإضافي لتوزيع الخصم بالتناسب
                let orderSubtotal = 0;
                order.items.forEach(item => {
                    let itemGross = item.price * item.quantity;
                    let itemNet = itemGross;
                    if (item.customPrice !== undefined && item.customPrice < item.price) {
                        itemNet = item.customPrice * item.quantity;
                    } else if (item.hasDiscount && item.quantity >= item.discountQty) {
                        itemNet = itemGross - (itemGross * (item.discountPercent / 100));
                    }
                    orderSubtotal += itemNet;
                });

                // نسبة الخصم الإضافي من الفاتورة
                const orderDiscountAmount = order.discountAmount || 0;
                const discountRatio = orderSubtotal > 0 ? orderDiscountAmount / orderSubtotal : 0;

                order.items.forEach(item => {
                    const service = services.find(s => s.name === item.name);
                    if (service && service.hasCommission && service.commissionPercent > 0) {
                        // حساب الصافي بعد خصم الكمية/السعر المخصص
                        let itemGross = item.price * item.quantity;
                        let itemNet = itemGross;
                        // خصم يدوي
                        if (item.customPrice !== undefined && item.customPrice < item.price) {
                            itemNet = item.customPrice * item.quantity;
                        }
                        // خصم الكمية
                        else if (item.hasDiscount && item.quantity >= item.discountQty) {
                            itemNet = itemGross - (itemGross * (item.discountPercent / 100));
                        }

                        // توزيع خصم الفاتورة الإضافي على هذه الخدمة بالتناسب
                        const itemDiscountFromOrder = itemNet * discountRatio;
                        const finalItemNet = itemNet - itemDiscountFromOrder;

                        // حساب العمولة من الصافي النهائي (بعد كل الخصومات)
                        const commission = finalItemNet * (service.commissionPercent / 100);
                        if (!employeeCommissions[empName]) {
                            employeeCommissions[empName] = { name: empName, services: {}, totalCommission: 0 };
                        }
                        if (!employeeCommissions[empName].services[item.name]) {
                            employeeCommissions[empName].services[item.name] = { name: item.name, count: 0, revenue: 0, commission: 0, commissionPercent: service.commissionPercent };
                        }
                        employeeCommissions[empName].services[item.name].count += item.quantity;
                        employeeCommissions[empName].services[item.name].revenue += finalItemNet;
                        employeeCommissions[empName].services[item.name].commission += commission;
                        employeeCommissions[empName].totalCommission += commission;
                        totalCommission += commission;
                    }
                });
            });
            // Convert to array format
            const employees = Object.values(employeeCommissions).map(emp => ({
                name: emp.name,
                services: Object.values(emp.services),
                totalCommission: emp.totalCommission
            }));
            return { employees, total: totalCommission };
        }

        let services = JSON.parse(localStorage.getItem('services')) || defaultServices;
        let employees = JSON.parse(localStorage.getItem('employees')) || ['أحمد', 'محمد', 'عبدالله'];
        let fixedExpenses = JSON.parse(localStorage.getItem('fixedExpenses')) || [];
        let shopInfo = JSON.parse(localStorage.getItem('shopInfo_mustaqbal')) || { name: 'مكتبة المستقبل', phone: '', address: '', taxNumber: '' };
        let currentOrder = { customerId: null, customerName: '', items: [], discount: 0, notes: '' };

        // ============ Authentication ============
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.querySelector('.login-box .btn-primary');
            const loginError = document.getElementById('loginError');
            const originalText = loginBtn.innerHTML;

            // Show loading
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحقق...';
            loginBtn.disabled = true;
            loginError.style.display = 'none';

            try {
                // Login from Google Sheets using GET request
                const url = new URL(WEB_APP_URL);
                url.searchParams.append('action', 'login');
                url.searchParams.append('username', username);
                url.searchParams.append('password', password);

                console.log('Attempting login for:', username);
                const response = await fetch(url.toString());
                const result = await response.json();
                console.log('Login response:', result);

                if (result && result.success && result.user) {
                    currentUser = result.user;
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    showMainApp();
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                } else {
                    console.log('Login failed:', result.error, result.debug);
                    loginError.style.display = 'flex';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.style.display = 'flex';
            }

            // Reset button
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.body.classList.remove('accountant-mode');
        }

        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.fullName;
            document.getElementById('currentUserRole').textContent = currentUser.role === 'admin' ? 'مدير' : 'محاسب';
            if (currentUser.role === 'accountant') {
                document.body.classList.add('accountant-mode');
            } else {
                document.body.classList.remove('accountant-mode');
            }
            initializeApp();
        }

        function isAdmin() { return currentUser && currentUser.role === 'admin'; }

        // ============ Initialization ============
        async function initializeApp() {
            if (!WEB_APP_URL) {
                showSection('setupSection');
                document.getElementById('setupSection').classList.add('active');
            } else {
                showSection('dashboard');
                // تحميل البيانات من السحابة أولاً
                await loadAllDataFromCloud();
                loadDashboard();
            }
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dailyReportDate').value = today;
            loadShopInfo();
            renderServices();
            renderServicesSettings();
            renderEmployeesSettings();
            renderFixedExpensesSettings();
            loadEmployeesDropdown();
            loadCustomersDropdown();
            renderUsersTable();
            document.getElementById('currentWebAppUrl').value = WEB_APP_URL;
            document.getElementById('modalServiceHasDiscount').addEventListener('change', function() {
                document.getElementById('discountSettings').style.display = this.checked ? 'block' : 'none';
            });
            document.getElementById('modalServiceHasCommission').addEventListener('change', function() {
                document.getElementById('commissionSettings').style.display = this.checked ? 'block' : 'none';
            });
            document.getElementById('editServiceHasDiscount').addEventListener('change', function() {
                document.getElementById('editDiscountSettings').style.display = this.checked ? 'block' : 'none';
            });
            document.getElementById('editServiceHasCommission').addEventListener('change', function() {
                document.getElementById('editCommissionSettings').style.display = this.checked ? 'block' : 'none';
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                const userExists = users.find(u => u.id === currentUser.id);
                if (userExists) showMainApp();
                else logout();
            }
        });

        // ============ Setup ============
        function saveWebAppUrl() {
            const url = document.getElementById('webAppUrl').value.trim();
            if (!url) { showAlert('يرجى إدخال رابط Web App', 'error'); return; }
            WEB_APP_URL = url;
            localStorage.setItem('webAppUrl', url);
            showAlert('تم حفظ الرابط بنجاح!', 'success');
            showSection('dashboard');
            loadDashboard();
        }

        function changeWebAppUrl() {
            document.getElementById('webAppUrl').value = WEB_APP_URL;
            showSection('setupSection');
            document.getElementById('setupSection').classList.add('active');
        }

        // ============ API Functions ============
        async function apiCall(action, data = {}) {
            if (!WEB_APP_URL) return null;
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, ...data })
                });
                const result = await response.json();
                console.log('API Response for', action, ':', result);
                return result;
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }

        async function apiGet(action, params = {}) {
            if (!WEB_APP_URL) return getMockData(action, params);
            try {
                const url = new URL(WEB_APP_URL);
                url.searchParams.append('action', action);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                const response = await fetch(url.toString());
                return await response.json();
            } catch (error) { console.error('API Error:', error); return getMockData(action, params); }
        }

        // تحميل جميع البيانات من Google Sheets عند بدء التطبيق
        async function loadAllDataFromCloud() {
            try {
                const data = await apiGet('getAllData');
                if (data && !data.error) {
                    if (data.services && data.services.length > 0) {
                        services = data.services;
                        localStorage.setItem('services', JSON.stringify(services));
                    }
                    if (data.employees && data.employees.length > 0) {
                        employees = data.employees;
                        localStorage.setItem('employees', JSON.stringify(employees));
                    }
                    if (data.fixedExpenses) {
                        fixedExpenses = data.fixedExpenses;
                        localStorage.setItem('fixedExpenses', JSON.stringify(fixedExpenses));
                    }
                    // تحميل المستخدمين من Google Sheets
                    if (data.users && data.users.length > 0) {
                        users = data.users;
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                    if (data.orders) localStorage.setItem('mockOrders', JSON.stringify(data.orders));
                    if (data.customers) localStorage.setItem('mockCustomers', JSON.stringify(data.customers));
                    if (data.inventory) localStorage.setItem('mockInventory', JSON.stringify(data.inventory));
                    if (data.expenses) localStorage.setItem('mockExpenses', JSON.stringify(data.expenses));
                    return true;
                }
            } catch (error) { console.error('Error loading cloud data:', error); }
            return false;
        }

        async function autoSaveEmployees() {
            localStorage.setItem('employees', JSON.stringify(employees));
            await apiCall('saveEmployees', { employees: employees });
        }

        async function autoSaveServices() {
            localStorage.setItem('services', JSON.stringify(services));
            await apiCall('saveServices', { services: services });
        }

        async function autoSaveFixedExpenses() {
            localStorage.setItem('fixedExpenses', JSON.stringify(fixedExpenses));
            await apiCall('saveFixedExpenses', { fixedExpenses: fixedExpenses });
        }

        function getMockData(action, params) {
            const mockOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
            const mockCustomers = JSON.parse(localStorage.getItem('mockCustomers') || '[]');
            const mockInventory = JSON.parse(localStorage.getItem('mockInventory') || '[]');
            const mockExpenses = JSON.parse(localStorage.getItem('mockExpenses') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = mockOrders.filter(o => o.date.startsWith(today));
            const todayExpenses = mockExpenses.filter(e => e.date.startsWith(today));
            const monthOrders = mockOrders.filter(o => { const d = new Date(o.date); return d.getMonth() === new Date().getMonth() && d.getFullYear() === new Date().getFullYear(); });
            const monthExpenses = mockExpenses.filter(e => { const d = new Date(e.date); return d.getMonth() === new Date().getMonth() && d.getFullYear() === new Date().getFullYear(); });
            switch(action) {
                case 'getDashboard': return { todaySales: todayOrders.reduce((sum, o) => sum + o.total, 0), todayOrders: todayOrders.length, monthSales: monthOrders.reduce((sum, o) => sum + o.total, 0), totalCustomers: mockCustomers.length, recentOrders: mockOrders.slice(-5).reverse(), lowInventory: mockInventory.filter(i => i.quantity <= i.minQuantity), todayExpenses: todayExpenses.reduce((sum, e) => sum + e.amount, 0), monthExpenses: monthExpenses.reduce((sum, e) => sum + e.amount, 0) };
                case 'getOrders': return { orders: [...mockOrders].reverse() };
                case 'getCustomers': return { customers: mockCustomers };
                case 'getInventory': return { items: mockInventory };
                case 'getExpenses': return { expenses: [...mockExpenses].reverse(), todayTotal: todayExpenses.reduce((sum, e) => sum + e.amount, 0), monthTotal: monthExpenses.reduce((sum, e) => sum + e.amount, 0) };
                default: return {};
            }
        }

        // ============ Navigation ============
        function showSection(sectionId) {
            if ((sectionId === 'reports' || sectionId === 'settings' || sectionId === 'deposits') && !isAdmin()) { showAlert('ليس لديك صلاحية للوصول لهذا القسم', 'error'); return; }
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const section = document.getElementById(sectionId);
            if (section) section.classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => { if (btn.textContent.includes(getSectionName(sectionId))) btn.classList.add('active'); });
            if (sectionId === 'dashboard') loadDashboard();
            else if (sectionId === 'orders') loadOrders();
            else if (sectionId === 'customers') loadCustomers();
            else if (sectionId === 'inventory') loadInventory();
            else if (sectionId === 'expenses') loadExpenses();
            else if (sectionId === 'deposits') { initDepositFilter(); loadDeposits(); }
            else if (sectionId === 'reports') loadDailyReport();
            else if (sectionId === 'newOrder') { renderServices(); loadCustomersDropdown(); }
        }

        function getSectionName(id) { const names = { dashboard: 'الرئيسية', newOrder: 'طلب جديد', orders: 'الطلبات', customers: 'العملاء', inventory: 'المخزون', reports: 'التقارير', settings: 'الإعدادات', expenses: 'المصروفات', deposits: 'الإيداعات' }; return names[id] || ''; }

        // ============ Dashboard ============
        function updateDashboardFilter() {
            const filterType = document.getElementById('dashboardFilterType').value;
            const dateInput = document.getElementById('dashboardFilterDate');

            if (filterType === 'day') {
                dateInput.style.display = 'block';
                if (!dateInput.value) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            } else {
                dateInput.style.display = 'none';
            }
            loadDashboard();
        }

        async function loadDashboard() {
            const data = await apiGet('getDashboard');
            if (data) {
                // حساب الخصومات والصافي من الطلبات
                const mockOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
                const today = new Date().toISOString().split('T')[0];
                const todayOrders = mockOrders.filter(o => o.date && o.date.startsWith(today));

                let todayGross = 0, todayDiscount = 0;
                todayOrders.forEach(order => {
                    if (!order.items) return;
                    order.items.forEach(item => {
                        const itemGross = item.price * item.quantity;
                        todayGross += itemGross;
                        if (item.customPrice !== undefined && item.customPrice < item.price) {
                            todayDiscount += (item.price - item.customPrice) * item.quantity;
                        } else if (item.hasDiscount && item.quantity >= item.discountQty) {
                            todayDiscount += itemGross * (item.discountPercent / 100);
                        }
                    });
                    if (order.discountAmount) todayDiscount += order.discountAmount;
                });
                const todayNet = todayGross - todayDiscount;

                if (isAdmin()) {
                    document.getElementById('todaySales').textContent = formatNumber(todayGross);
                    document.getElementById('todayDiscount').textContent = formatNumber(todayDiscount);
                    document.getElementById('todayNetSales').textContent = formatNumber(todayNet);
                    document.getElementById('monthSales').textContent = formatNumber(data.monthSales || 0);
                } else {
                    // للمحاسب: عرض إجمالي المبيعات والمطلوب توريده
                    document.getElementById('accountantTodaySales').textContent = formatNumber(todayNet);
                    const todayExpensesAmount = data.todayExpenses || 0;
                    const amountToDeposit = todayNet - todayExpensesAmount;
                    document.getElementById('amountToDeposit').textContent = formatNumber(amountToDeposit);
                }
                document.getElementById('todayOrders').textContent = data.todayOrders || 0;
                document.getElementById('todayExpenses').textContent = formatNumber(data.todayExpenses || 0);

                // استخدام الطلبات من localStorage لضمان عرض الكل
                const allOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
                // تحويل الطلبات لصيغة العرض
                let ordersToShow = allOrders.map(order => ({
                    id: order.id,
                    customerName: order.customerName,
                    services: order.items ? order.items.map(i => `${i.name}(${i.quantity})`).join(', ') : order.services || '',
                    total: order.total || 0,
                    date: order.date,
                    status: order.status || 'مكتمل'
                })).sort((a, b) => new Date(b.date) - new Date(a.date));
                if (isAdmin()) {
                    const filterType = document.getElementById('dashboardFilterType').value;
                    const filterDate = document.getElementById('dashboardFilterDate').value;

                    if (filterType === 'today') {
                        ordersToShow = ordersToShow.filter(o => o.date && o.date.split('T')[0] === today);
                    } else if (filterType === 'day' && filterDate) {
                        ordersToShow = ordersToShow.filter(o => o.date && o.date.split('T')[0] === filterDate);
                    }
                    // filterType === 'all' يعرض كل الطلبات
                } else {
                    // المحاسب يرى طلبات اليوم فقط
                    ordersToShow = ordersToShow.filter(o => o.date && o.date.split('T')[0] === today);
                }

                const tbody = document.getElementById('recentOrdersTable');
                if (ordersToShow.length > 0) {
                    tbody.innerHTML = ordersToShow.map(order => `<tr><td>#${order.id}</td><td>${order.customerName}</td><td>${order.services}</td>${isAdmin() ? `<td>${formatNumber(order.total)} جنيه</td>` : ''}<td>${formatDate(order.date)}</td><td><span style="color: ${order.status === 'مكتمل' ? '#00ff88' : '#ffaa00'}">${order.status}</span></td>${isAdmin() ? `<td><button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteDashboardOrder(${order.id})"><i class="fas fa-trash"></i></button></td>` : ''}</tr>`).join('');
                } else { tbody.innerHTML = `<tr><td colspan="${isAdmin() ? 7 : 5}" style="text-align: center;">لا توجد طلبات</td></tr>`; }
                const alertsDiv = document.getElementById('inventoryAlerts');
                if (data.lowInventory && data.lowInventory.length > 0) { alertsDiv.innerHTML = data.lowInventory.map(item => `<div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i><span>${item.name}: الكمية المتبقية ${item.quantity} ${item.unit}</span></div>`).join(''); }
                else { alertsDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> المخزون في حالة جيدة</div>'; }
            }
        }

        // حذف طلب من الداشبورد
        function deleteDashboardOrder(orderId) {
            if (!confirm('هل أنت متأكد من حذف هذا الطلب؟')) return;
            let mockOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
            mockOrders = mockOrders.filter(o => o.id !== orderId);
            localStorage.setItem('mockOrders', JSON.stringify(mockOrders));
            apiCall('deleteOrder', { id: orderId });
            showAlert('تم حذف الطلب بنجاح', 'success');
            loadDashboard();
        }

        // ============ Expenses ============
        async function loadExpenses() {
            const data = await apiGet('getExpenses');
            if (data) {
                document.getElementById('expensesToday').textContent = (data.todayTotal || 0).toFixed(2);
                // إخفاء مصروفات الشهر للمحاسب
                const monthCard = document.getElementById('expensesMonthCard');
                if (monthCard) monthCard.style.display = isAdmin() ? 'block' : 'none';
                if (isAdmin()) document.getElementById('expensesMonth').textContent = (data.monthTotal || 0).toFixed(2);

                const tbody = document.getElementById('expensesTable');
                let expensesToShow = data.expenses || [];

                // للمحاسب: عرض مصروفات اليوم فقط
                if (!isAdmin()) {
                    const today = new Date().toISOString().split('T')[0];
                    expensesToShow = expensesToShow.filter(exp => exp.date && exp.date.startsWith(today));
                }

                if (expensesToShow.length > 0) {
                    tbody.innerHTML = expensesToShow.map(exp => `<tr><td>${formatDate(exp.date)}</td><td>${exp.description}</td><td>${exp.category}</td><td style="color: #ffaa00;">${exp.amount.toFixed(2)} جنيه</td><td>${exp.createdBy}</td><td>${isAdmin() ? `<button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" onclick="deleteExpense(${exp.id})"><i class="fas fa-trash"></i></button>` : '-'}</td></tr>`).join('');
                } else { tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد مصروفات اليوم</td></tr>'; }
            }
        }

        function showAddExpenseModal() { document.getElementById('addExpenseModal').classList.add('active'); }

        async function addExpense() {
            const desc = document.getElementById('modalExpenseDesc').value.trim();
            const amount = parseFloat(document.getElementById('modalExpenseAmount').value) || 0;
            const category = document.getElementById('modalExpenseCategory').value;
            const notes = document.getElementById('modalExpenseNotes').value.trim();
            if (!desc || !amount) { showAlert('يرجى ملء الحقول المطلوبة', 'error'); return; }
            const expense = { id: Date.now(), description: desc, amount: amount, category: category, notes: notes, date: new Date().toISOString(), createdBy: currentUser.fullName };
            await apiCall('addExpense', expense);
            const mockExpenses = JSON.parse(localStorage.getItem('mockExpenses') || '[]');
            mockExpenses.push(expense);
            localStorage.setItem('mockExpenses', JSON.stringify(mockExpenses));
            showAlert('تم إضافة المصروف بنجاح!', 'success');
            closeModal('addExpenseModal');
            loadExpenses();
            loadDashboard();
            document.getElementById('modalExpenseDesc').value = '';
            document.getElementById('modalExpenseAmount').value = '';
            document.getElementById('modalExpenseNotes').value = '';
        }

        function deleteExpense(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                let mockExpenses = JSON.parse(localStorage.getItem('mockExpenses') || '[]');
                mockExpenses = mockExpenses.filter(e => e.id !== id);
                localStorage.setItem('mockExpenses', JSON.stringify(mockExpenses));
                apiCall('deleteExpense', { id });
                showAlert('تم حذف المصروف', 'success');
                loadExpenses();
                loadDashboard();
            }
        }

        // ============ Services ============
        function renderServices() {
            const grid = document.getElementById('servicesGrid');
            grid.innerHTML = services.map(service => `<div class="service-card" id="service-${service.id}" onclick="toggleService(${service.id})"><i class="fas ${service.icon}"></i><h4>${service.name}</h4><div class="price">${service.price.toFixed(2)} جنيه</div>${service.hasDiscount ? '<small style="color: #ffaa00;">خصم للكميات</small>' : ''}</div>`).join('');
        }

        function toggleService(serviceId) {
            const card = document.getElementById(`service-${serviceId}`);
            const service = services.find(s => s.id === serviceId);
            if (card.classList.contains('selected')) { card.classList.remove('selected'); currentOrder.items = currentOrder.items.filter(i => i.serviceId !== serviceId); }
            else { card.classList.add('selected'); currentOrder.items.push({ serviceId: serviceId, name: service.name, price: service.price, quantity: 1, hasDiscount: service.hasDiscount, discountQty: service.discountQty, discountPercent: service.discountPercent }); }
            updateSelectedServices(); updateOrderSummary();
        }

        function updateSelectedServices() {
            const container = document.getElementById('selectedServicesContainer');
            const list = document.getElementById('selectedServicesList');
            if (currentOrder.items.length === 0) { container.style.display = 'none'; return; }
            container.style.display = 'block';
            list.innerHTML = currentOrder.items.map((item, index) => `
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <strong style="flex: 1; min-width: 200px;">${item.name}</strong>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="changeQuantity(${index}, -1)">-</button>
                            <input type="number" class="form-group quantity-input" value="${item.quantity}" onchange="setQuantity(${index}, this.value)" min="1">
                            <button class="quantity-btn" onclick="changeQuantity(${index}, 1)">+</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" class="form-group" style="width: 120px; text-align: center; font-size: 1.1rem; font-weight: 600; padding: 8px; background: rgba(0,212,255,0.2); border: 2px solid #00d4ff; color: #00d4ff;"
                                value="${item.customPrice !== undefined ? item.customPrice : item.price}"
                                onchange="setItemPrice(${index}, this.value)"
                                title="السعر (يمكنك تغييره للخصم)" min="0" step="0.5">
                            <span style="color: #00d4ff;">جنيه</span>
                        </div>
                    </div>
                    ${item.hasDiscount && item.quantity >= item.discountQty ? `<small style="color: #00ff88;">✓ خصم ${item.discountPercent}%</small>` : (item.hasDiscount ? `<small style="color: #ffaa00;">اطلب ${item.discountQty}+ للخصم</small>` : '')}
                    ${item.customPrice !== undefined && item.customPrice < item.price ? `<br><small style="color: #00ff88;">✓ تخفيض خاص: ${((1 - item.customPrice / item.price) * 100).toFixed(0)}%</small>` : ''}
                </div>
            `).join('');
        }

        function setItemPrice(index, value) {
            const newPrice = Math.max(0, parseFloat(value) || 0);
            currentOrder.items[index].customPrice = newPrice;
            updateSelectedServices();
            updateOrderSummary();
        }

        function changeQuantity(index, delta) { const newQty = currentOrder.items[index].quantity + delta; if (newQty >= 1) { currentOrder.items[index].quantity = newQty; updateSelectedServices(); updateOrderSummary(); } }
        function setQuantity(index, value) { currentOrder.items[index].quantity = Math.max(1, parseInt(value) || 1); updateSelectedServices(); updateOrderSummary(); }

        function updateOrderSummary() {
            const summary = document.getElementById('orderSummary');
            const itemsDiv = document.getElementById('orderItems');
            if (currentOrder.items.length === 0) { summary.style.display = 'none'; return; }
            summary.style.display = 'block';
            let subtotal = 0;
            itemsDiv.innerHTML = currentOrder.items.map(item => {
                // استخدام السعر المخصص إذا تم تعديله
                const effectivePrice = item.customPrice !== undefined ? item.customPrice : item.price;
                let itemTotal = effectivePrice * item.quantity;
                let discountApplied = 0;
                // تطبيق خصم الكمية فقط إذا لم يتم تعديل السعر يدوياً
                if (item.customPrice === undefined && item.hasDiscount && item.quantity >= item.discountQty) {
                    discountApplied = itemTotal * (item.discountPercent / 100);
                    itemTotal -= discountApplied;
                }
                subtotal += itemTotal;
                const customDiscount = item.customPrice !== undefined && item.customPrice < item.price;
                return `<div class="order-item"><span>${item.name} × ${item.quantity}</span><span>${itemTotal.toFixed(2)} جنيه ${discountApplied > 0 ? `<small style="color:#00ff88">(-${discountApplied.toFixed(2)})</small>` : ''} ${customDiscount ? `<small style="color:#00ff88">(سعر خاص)</small>` : ''}</span></div>`;
            }).join('');
            document.getElementById('orderTotal').textContent = subtotal.toFixed(2) + ' جنيه';
            const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
            const finalTotal = Math.max(0, subtotal - discountAmount);
            document.getElementById('orderTotalAfterDiscount').textContent = finalTotal.toFixed(2) + ' جنيه';
            currentOrder.discountAmount = discountAmount;
        }

        // ============ Customer Selection ============
        async function loadCustomersDropdown() {
            const data = await apiGet('getCustomers');
            const select = document.getElementById('customerSelect');
            select.innerHTML = '<option value="">-- اختر عميل --</option><option value="new">+ عميل جديد</option>';
            if (data && data.customers) data.customers.forEach(c => select.innerHTML += `<option value="${c.id}">${c.name} - ${c.phone || 'بدون رقم'}</option>`);
        }

        function handleCustomerSelect() {
            const value = document.getElementById('customerSelect').value;
            document.getElementById('newCustomerName').style.display = value === 'new' ? 'block' : 'none';
            document.getElementById('newCustomerPhone').style.display = value === 'new' ? 'block' : 'none';
            if (value !== 'new' && value) { currentOrder.customerId = value; currentOrder.customerName = document.getElementById('customerSelect').selectedOptions[0].text.split(' - ')[0]; }
        }

        // ============ Order Management ============
        async function saveOrder() {
            if (currentOrder.items.length === 0) { showAlert('يرجى اختيار خدمة واحدة على الأقل', 'error'); return; }
            const customerSelect = document.getElementById('customerSelect');
            if (customerSelect.value === 'new') { currentOrder.customerName = document.getElementById('newCustomerName').value || 'عميل'; const phone = document.getElementById('newCustomerPhone').value; if (currentOrder.customerName !== 'عميل') await saveNewCustomer(currentOrder.customerName, phone); }
            else if (customerSelect.value) { currentOrder.customerName = customerSelect.selectedOptions[0].text.split(' - ')[0]; currentOrder.customerId = customerSelect.value; }
            else { currentOrder.customerName = 'عميل'; }
            currentOrder.notes = document.getElementById('orderNotes').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const employeeName = document.getElementById('employeeName').value.trim() || '';
            let subtotal = 0;
            currentOrder.items.forEach(item => { let itemTotal = item.price * item.quantity; if (item.hasDiscount && item.quantity >= item.discountQty) itemTotal -= itemTotal * (item.discountPercent / 100); subtotal += itemTotal; });
            const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
            const total = Math.max(0, subtotal - discountAmount);
            const order = { id: Date.now(), customerId: currentOrder.customerId, customerName: currentOrder.customerName, employeeName, items: currentOrder.items, services: currentOrder.items.map(i => `${i.name}(${i.quantity})`).join(', '), subtotal, discountAmount, total, paymentMethod, notes: currentOrder.notes, date: new Date().toISOString(), status: 'مكتمل', createdBy: currentUser.fullName };
            await apiCall('addOrder', order);
            const mockOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
            mockOrders.push(order);
            localStorage.setItem('mockOrders', JSON.stringify(mockOrders));
            showAlert('تم حفظ الطلب بنجاح!', 'success');
            return order;
        }

        async function saveAndPrintOrder() { const order = await saveOrder(); if (order) { showInvoice(order); clearOrder(); } }

        function clearOrder() {
            currentOrder = { customerId: null, customerName: '', items: [], discountAmount: 0, notes: '' };
            document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('selectedServicesContainer').style.display = 'none';
            document.getElementById('orderSummary').style.display = 'none';
            document.getElementById('customerSelect').value = '';
            document.getElementById('newCustomerName').value = ''; document.getElementById('newCustomerPhone').value = '';
            document.getElementById('newCustomerName').style.display = 'none'; document.getElementById('newCustomerPhone').style.display = 'none';
            document.getElementById('discountAmount').value = 0; document.getElementById('orderNotes').value = '';
            document.getElementById('paymentMethod').value = 'نقدي';
            document.getElementById('employeeName').value = '';
        }

        function showInvoice(order) {
            const discountRow = order.discountAmount > 0 ? `<tr><td colspan="3" style="text-align: left;">الخصم:</td><td>-${order.discountAmount.toFixed(2)} جنيه</td></tr>` : '';
            // الختم الدائري الاحترافي بتصميم SVG - لون أزرق فاتح
            const stampColor = '#5dade2';
            const stamp = `
                <div style="position: relative; margin-top: 30px; display: flex; justify-content: center;">
                    <svg width="160" height="160" viewBox="0 0 200 200" style="transform: rotate(-8deg);">
                        <!-- الدائرة الخارجية -->
                        <circle cx="100" cy="100" r="95" fill="none" stroke="${stampColor}" stroke-width="4"/>
                        <!-- الدائرة الداخلية -->
                        <circle cx="100" cy="100" r="60" fill="none" stroke="${stampColor}" stroke-width="2"/>
                        <!-- النقطتان على الجانبين -->
                        <circle cx="18" cy="100" r="6" fill="${stampColor}"/>
                        <circle cx="182" cy="100" r="6" fill="${stampColor}"/>
                        <!-- مسار النص العلوي المنحني - في منتصف الحلقة -->
                        <defs>
                            <path id="topArc" d="M 25,100 A 75,75 0 0,1 175,100" fill="none"/>
                        </defs>
                        <!-- النص العلوي (اسم المحل) - واضح وكبير -->
                        <text fill="${stampColor}" font-size="15" font-weight="bold" font-family="Arial, sans-serif">
                            <textPath href="#topArc" startOffset="50%" text-anchor="middle">
                                ★ ${shopInfo.name} ★
                            </textPath>
                        </text>
                        <!-- النص في المنتصف (مدفوع) -->
                        <text x="100" y="105" fill="${stampColor}" font-size="28" font-weight="bold" font-family="Arial, sans-serif" text-anchor="middle" dominant-baseline="middle">
                            مدفوع
                        </text>
                        <!-- التاريخ في الأسفل (مستقيم) -->
                        <text x="100" y="145" fill="${stampColor}" font-size="12" font-family="Arial, sans-serif" text-anchor="middle">
                            ${formatDate(order.date).split('،')[0]}
                        </text>
                    </svg>
                </div>
            `;
            document.getElementById('invoiceContent').innerHTML = `<div class="invoice"><div class="invoice-header"><h2>${shopInfo.name}</h2>${shopInfo.phone ? `<p>هاتف: ${shopInfo.phone}</p>` : ''}${shopInfo.address ? `<p>${shopInfo.address}</p>` : ''}</div><div style="display: flex; justify-content: space-between; margin-bottom: 20px;"><div><strong>رقم الفاتورة:</strong> #${order.id}<br><strong>التاريخ:</strong> ${formatDate(order.date)}<br><strong>طريقة الدفع:</strong> ${order.paymentMethod || 'نقدي'}</div><div><strong>العميل:</strong> ${order.customerName}</div></div><table><thead><tr><th>الخدمة</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead><tbody>${order.items.map(item => { let itemTotal = item.price * item.quantity; let discount = 0; if (item.hasDiscount && item.quantity >= item.discountQty) { discount = itemTotal * (item.discountPercent / 100); itemTotal -= discount; } return `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${item.price.toFixed(2)} جنيه</td><td>${itemTotal.toFixed(2)} جنيه</td></tr>`; }).join('')}</tbody><tfoot><tr><td colspan="3" style="text-align: left;"><strong>المجموع:</strong></td><td><strong>${order.subtotal.toFixed(2)} جنيه</strong></td></tr>${discountRow}<tr style="background: #e8f5e9;"><td colspan="3" style="text-align: left;"><strong>الإجمالي النهائي:</strong></td><td><strong>${order.total.toFixed(2)} جنيه</strong></td></tr></tfoot></table>${stamp}<div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #000;"><p>شكراً لتعاملكم معنا!</p></div></div>`;
            document.getElementById('invoiceModal').classList.add('active');
        }

        function printInvoice() { window.print(); }

        // ============ Orders List ============
        async function loadOrders() {
            const data = await apiGet('getOrders');
            const tbody = document.getElementById('ordersTable');
            if (data && data.orders && data.orders.length > 0) {
                tbody.innerHTML = data.orders.map(order => `<tr><td>#${order.id}</td><td>${order.customerName}</td><td>${order.services}</td><td>${order.subtotal.toFixed(2)} جنيه</td><td>${(order.discountAmount || 0).toFixed(2)} جنيه</td><td>${order.total.toFixed(2)} جنيه</td><td><span style="color: ${order.paymentMethod === 'بنكك' ? '#00d4ff' : '#00ff88'}">${order.paymentMethod || 'نقدي'}</span></td><td>${formatDate(order.date)}</td><td><span style="color: ${order.status === 'مكتمل' ? '#00ff88' : '#ffaa00'}">${order.status}</span></td><td><button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick='showInvoice(${JSON.stringify(order)})'><i class="fas fa-print"></i></button></td></tr>`).join('');
            }
            else { tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">لا توجد طلبات</td></tr>'; }
        }

        // ============ Deposits ============
        let deposits = JSON.parse(localStorage.getItem('deposits')) || [];

        function initDepositFilter() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('depositFilterDate').value = today;
            document.getElementById('depositFilterMonth').value = today.substring(0, 7);
            document.getElementById('depositFilterType').value = 'all';
            document.getElementById('depositFilterDate').style.display = 'none';
            document.getElementById('depositFilterMonth').style.display = 'none';
        }

        function updateDepositFilter() {
            const filterType = document.getElementById('depositFilterType').value;
            const dateInput = document.getElementById('depositFilterDate');
            const monthInput = document.getElementById('depositFilterMonth');

            if (filterType === 'day') {
                dateInput.style.display = 'block';
                monthInput.style.display = 'none';
                if (!dateInput.value) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            } else if (filterType === 'month') {
                dateInput.style.display = 'none';
                monthInput.style.display = 'block';
                if (!monthInput.value) {
                    monthInput.value = new Date().toISOString().substring(0, 7);
                }
            } else {
                dateInput.style.display = 'none';
                monthInput.style.display = 'none';
            }
            loadDeposits();
        }

        async function loadDeposits() {
            const data = await apiGet('getDeposits');
            if (data && data.deposits) {
                deposits = data.deposits;
                localStorage.setItem('deposits', JSON.stringify(deposits));
            }

            const today = new Date().toISOString().split('T')[0];
            const thisMonth = today.substring(0, 7);

            // تحديد الفلتر
            const filterType = document.getElementById('depositFilterType').value;
            const filterDate = document.getElementById('depositFilterDate').value;
            const filterMonth = document.getElementById('depositFilterMonth').value;

            let monthTotal = 0, allTotal = 0, filteredTotal = 0;
            let filteredDeposits = [];

            deposits.forEach(d => {
                const amount = parseFloat(d.amount) || 0;
                const depositDate = d.date ? d.date.split('T')[0] : '';
                const depositMonth = depositDate.substring(0, 7);

                allTotal += amount;
                if (depositMonth === thisMonth) monthTotal += amount;

                // تطبيق الفلتر
                let includeInFilter = false;
                if (filterType === 'all') {
                    includeInFilter = true;
                } else if (filterType === 'day' && filterDate) {
                    includeInFilter = depositDate === filterDate;
                } else if (filterType === 'month' && filterMonth) {
                    includeInFilter = depositMonth === filterMonth;
                } else {
                    includeInFilter = true;
                }

                if (includeInFilter) {
                    filteredTotal += amount;
                    filteredDeposits.push(d);
                }
            });

            document.getElementById('filteredDeposits').textContent = formatNumber(filteredTotal);
            document.getElementById('monthDeposits').textContent = formatNumber(monthTotal);
            document.getElementById('totalDeposits').textContent = formatNumber(allTotal);

            const tbody = document.getElementById('depositsTable');
            if (filteredDeposits.length > 0) {
                tbody.innerHTML = filteredDeposits.map(d => `<tr>
                    <td>${formatDate(d.date)}</td>
                    <td>${formatNumber(parseFloat(d.amount) || 0)} جنيه</td>
                    <td>${d.bank || '-'}</td>
                    <td>${d.description || '-'}</td>
                    <td>${d.createdBy || '-'}</td>
                    <td>${isAdmin() ? `<button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteDeposit(${d.id})"><i class="fas fa-trash"></i></button>` : '-'}</td>
                </tr>`).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد إيداعات في هذه الفترة</td></tr>';
            }
        }

        function showAddDepositModal() {
            // ضبط التاريخ على اليوم
            document.getElementById('modalDepositDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('modalDepositAmount').value = '';
            document.getElementById('modalDepositDesc').value = '';
            document.getElementById('modalDepositBank').value = 'بنكك';
            document.getElementById('addDepositModal').classList.add('active');
        }

        async function addDeposit() {
            const depositDate = document.getElementById('modalDepositDate').value;
            const amount = parseFloat(document.getElementById('modalDepositAmount').value);
            const bank = document.getElementById('modalDepositBank').value;
            const description = document.getElementById('modalDepositDesc').value;

            if (!depositDate) {
                alert('الرجاء اختيار تاريخ الإيداع');
                return;
            }

            if (!amount || amount <= 0) {
                alert('الرجاء إدخال مبلغ صحيح');
                return;
            }

            const deposit = {
                id: Date.now(),
                amount,
                bank,
                description,
                date: depositDate + 'T' + new Date().toTimeString().split(' ')[0],
                createdBy: currentUser.fullName
            };

            deposits.unshift(deposit);
            localStorage.setItem('deposits', JSON.stringify(deposits));
            await apiCall('addDeposit', deposit);
            closeModal('addDepositModal');
            loadDeposits();
        }

        async function deleteDeposit(id) {
            if (!confirm('هل أنت متأكد من حذف هذا الإيداع؟')) return;
            deposits = deposits.filter(d => d.id !== id);
            localStorage.setItem('deposits', JSON.stringify(deposits));
            await apiCall('deleteDeposit', { id });
            loadDeposits();
        }

        // ============ Customers ============
        async function loadCustomers() {
            const data = await apiGet('getCustomers');
            const tbody = document.getElementById('customersTable');
            if (data && data.customers && data.customers.length > 0) { tbody.innerHTML = data.customers.map(c => `<tr><td>${c.name}</td><td>${c.phone || '-'}</td><td>${c.orderCount || 0}</td>${isAdmin() ? `<td>${(c.totalSpent || 0).toFixed(2)} جنيه</td>` : ''}<td>${c.lastVisit ? formatDate(c.lastVisit) : '-'}</td><td><button class="btn btn-secondary" style="padding: 5px 10px;"><i class="fas fa-edit"></i></button></td></tr>`).join(''); }
            else { tbody.innerHTML = `<tr><td colspan="${isAdmin() ? 6 : 5}" style="text-align: center;">لا يوجد عملاء</td></tr>`; }
        }

        function showAddCustomerModal() { document.getElementById('addCustomerModal').classList.add('active'); }

        async function addCustomer() {
            const name = document.getElementById('modalCustomerName').value.trim();
            const phone = document.getElementById('modalCustomerPhone').value.trim();
            const email = document.getElementById('modalCustomerEmail').value.trim();
            const notes = document.getElementById('modalCustomerNotes').value.trim();
            if (!name) { showAlert('يرجى إدخال اسم العميل', 'error'); return; }
            await saveNewCustomer(name, phone, email, notes);
            closeModal('addCustomerModal');
            loadCustomers(); loadCustomersDropdown();
            document.getElementById('modalCustomerName').value = ''; document.getElementById('modalCustomerPhone').value = '';
            document.getElementById('modalCustomerEmail').value = ''; document.getElementById('modalCustomerNotes').value = '';
        }

        async function saveNewCustomer(name, phone, email = '', notes = '') {
            const customer = { id: Date.now(), name, phone, email, notes, orderCount: 0, totalSpent: 0, createdAt: new Date().toISOString() };
            await apiCall('addCustomer', customer);
            const mockCustomers = JSON.parse(localStorage.getItem('mockCustomers') || '[]');
            mockCustomers.push(customer);
            localStorage.setItem('mockCustomers', JSON.stringify(mockCustomers));
            showAlert('تم إضافة العميل بنجاح!', 'success');
        }

        // ============ Inventory ============
        async function loadInventory() {
            const data = await apiGet('getInventory');
            const tbody = document.getElementById('inventoryTable');
            if (data && data.items && data.items.length > 0) { tbody.innerHTML = data.items.map(item => `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${item.minQuantity}</td><td>${item.unit}</td><td><span style="color: ${item.quantity <= item.minQuantity ? '#ff4757' : '#00ff88'}">${item.quantity <= item.minQuantity ? 'منخفض ⚠️' : 'متوفر ✓'}</span></td><td><button class="btn btn-secondary" style="padding: 5px 10px;"><i class="fas fa-edit"></i></button></td></tr>`).join(''); }
            else { tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد أصناف</td></tr>'; }
        }

        function showAddInventoryModal() { document.getElementById('addInventoryModal').classList.add('active'); }

        async function addInventoryItem() {
            const name = document.getElementById('modalItemName').value.trim();
            const qty = parseInt(document.getElementById('modalItemQty').value) || 0;
            const minQty = parseInt(document.getElementById('modalItemMinQty').value) || 0;
            const unit = document.getElementById('modalItemUnit').value;
            if (!name) { showAlert('يرجى إدخال اسم الصنف', 'error'); return; }
            const item = { id: Date.now(), name, quantity: qty, minQuantity: minQty, unit };
            await apiCall('addInventoryItem', item);
            const mockInventory = JSON.parse(localStorage.getItem('mockInventory') || '[]');
            mockInventory.push(item);
            localStorage.setItem('mockInventory', JSON.stringify(mockInventory));
            showAlert('تم إضافة الصنف بنجاح!', 'success');
            closeModal('addInventoryModal'); loadInventory();
            document.getElementById('modalItemName').value = ''; document.getElementById('modalItemQty').value = ''; document.getElementById('modalItemMinQty').value = '';
        }

        // ============ Reports ============
        function showReportTab(tab) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('dailyReport').style.display = tab === 'daily' ? 'block' : 'none';
            document.getElementById('monthlyReport').style.display = tab === 'monthly' ? 'block' : 'none';
            document.getElementById('servicesReport').style.display = tab === 'services' ? 'block' : 'none';
            if (tab === 'daily') loadDailyReport(); else if (tab === 'monthly') loadMonthlyReport(); else if (tab === 'services') loadServicesReport();
        }

        async function loadDailyReport() {
            const date = document.getElementById('dailyReportDate').value;
            const mockOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
            const mockExpenses = JSON.parse(localStorage.getItem('mockExpenses') || '[]');
            const dayOrders = mockOrders.filter(o => o.date.startsWith(date));
            const dayExpenses = mockExpenses.filter(e => e.date.startsWith(date));

            // حساب الإيرادات والخصومات
            let grossSales = 0;
            let totalDiscount = 0;
            dayOrders.forEach(order => {
                order.items.forEach(item => {
                    const itemGross = item.price * item.quantity;
                    grossSales += itemGross;
                    if (item.customPrice !== undefined && item.customPrice < item.price) {
                        totalDiscount += (item.price - item.customPrice) * item.quantity;
                    } else if (item.hasDiscount && item.quantity >= item.discountQty) {
                        totalDiscount += itemGross * (item.discountPercent / 100);
                    }
                });
                if (order.discountAmount) totalDiscount += order.discountAmount;
            });
            const netSales = grossSales - totalDiscount;

            const cashSales = dayOrders.filter(o => !o.paymentMethod || o.paymentMethod === 'نقدي').reduce((sum, o) => sum + o.total, 0);
            const bankSales = dayOrders.filter(o => o.paymentMethod === 'بنكك').reduce((sum, o) => sum + o.total, 0);
            const totalExpenses = dayExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = netSales - totalExpenses;
            const profitColor = netProfit >= 0 ? '#00ff88' : '#ff4757';
            const profitBorderColor = netProfit >= 0 ? 'rgba(0,255,136,0.3)' : 'rgba(255,71,87,0.3)';
            const commissionData = calculateCommission(dayOrders);
            document.getElementById('dailyReportContent').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card"><i class="fas fa-money-bill-wave stat-icon"></i><div class="stat-value">${formatNumber(grossSales)}</div><div class="stat-label">إجمالي المبيعات (جنيه)</div><small style="color: #00ff88;">نقدي: ${formatNumber(cashSales)}</small><br><small style="color: #00d4ff;">بنكك: ${formatNumber(bankSales)}</small></div>
                    <div class="stat-card" style="border-color: rgba(255,170,0,0.3);"><i class="fas fa-tags stat-icon" style="color: #ffaa00;"></i><div class="stat-value" style="color: #ffaa00;">${formatNumber(totalDiscount)}</div><div class="stat-label">إجمالي الخصومات (جنيه)</div></div>
                    <div class="stat-card" style="border-color: rgba(0,255,136,0.3);"><i class="fas fa-hand-holding-usd stat-icon" style="color: #00ff88;"></i><div class="stat-value" style="color: #00ff88;">${formatNumber(netSales)}</div><div class="stat-label">صافي المبيعات (جنيه)</div></div>
                    <div class="stat-card"><i class="fas fa-receipt stat-icon"></i><div class="stat-value">${dayOrders.length}</div><div class="stat-label">عدد الطلبات</div></div>
                    <div class="stat-card expense-card"><i class="fas fa-wallet stat-icon" style="color: #ffaa00;"></i><div class="stat-value" style="color: #ffaa00;">${formatNumber(totalExpenses)}</div><div class="stat-label">المصروفات (جنيه)</div></div>
                    <div class="stat-card" style="border-color: ${profitBorderColor};"><i class="fas fa-chart-line stat-icon" style="color: ${profitColor};"></i><div class="stat-value" style="color: ${profitColor};">${formatNumber(netProfit)}</div><div class="stat-label">صافي الربح (جنيه)</div></div>
                </div>
                ${commissionData.total > 0 ? `<div class="card" style="margin-top: 20px; background: rgba(255,170,0,0.1); border: 1px solid rgba(255,170,0,0.3);"><h4 style="color: #ffaa00; margin-bottom: 15px;"><i class="fas fa-user-tie"></i> عمولات الموظفين</h4>${commissionData.employees.map(emp => `<div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px;"><h5 style="color: #00d4ff; margin-bottom: 10px;"><i class="fas fa-user"></i> ${emp.name}</h5><div class="table-container"><table><thead><tr><th>الخدمة</th><th>الكمية</th><th>صافي الإيرادات</th><th>نسبة العمولة</th><th>قيمة العمولة</th></tr></thead><tbody>${emp.services.map(s => `<tr><td>${s.name}</td><td>${s.count}</td><td>${formatNumber(s.revenue)} جنيه</td><td>${s.commissionPercent}%</td><td style="color: #ffaa00;">${formatNumber(s.commission)} جنيه</td></tr>`).join('')}<tr style="background: rgba(255,170,0,0.2);"><td colspan="4"><strong>عمولة ${emp.name}:</strong></td><td style="color: #ffaa00;"><strong>${formatNumber(emp.totalCommission)} جنيه</strong></td></tr></tbody></table></div></div>`).join('')}<div style="padding: 15px; background: rgba(255,170,0,0.3); border-radius: 10px; text-align: center;"><strong>إجمالي جميع العمولات: <span style="color: #ffaa00; font-size: 1.3rem;">${formatNumber(commissionData.total)} جنيه</span></strong></div></div>` : ''}`;
        }

        async function loadMonthlyReport() {
            const mockOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
            const mockExpenses = JSON.parse(localStorage.getItem('mockExpenses') || '[]');
            const monthOrders = mockOrders.filter(o => { const d = new Date(o.date); return d.getMonth() === new Date().getMonth() && d.getFullYear() === new Date().getFullYear(); });
            const monthExpenses = mockExpenses.filter(e => { const d = new Date(e.date); return d.getMonth() === new Date().getMonth() && d.getFullYear() === new Date().getFullYear(); });

            // حساب الإيرادات والخصومات
            let grossSales = 0;
            let totalDiscount = 0;
            monthOrders.forEach(order => {
                order.items.forEach(item => {
                    const itemGross = item.price * item.quantity;
                    grossSales += itemGross;
                    // حساب الخصم
                    if (item.customPrice !== undefined && item.customPrice < item.price) {
                        totalDiscount += (item.price - item.customPrice) * item.quantity;
                    } else if (item.hasDiscount && item.quantity >= item.discountQty) {
                        totalDiscount += itemGross * (item.discountPercent / 100);
                    }
                });
                // خصم إضافي على الطلب
                if (order.discountAmount) totalDiscount += order.discountAmount;
            });
            const netSales = grossSales - totalDiscount;

            const cashOrders = monthOrders.filter(o => !o.paymentMethod || o.paymentMethod === 'نقدي');
            const bankOrders = monthOrders.filter(o => o.paymentMethod === 'بنكك');
            const cashSales = cashOrders.reduce((sum, o) => sum + o.total, 0);
            const bankSales = bankOrders.reduce((sum, o) => sum + o.total, 0);
            const dailyExpensesTotal = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
            const fixedExpensesTotal = fixedExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalExpenses = dailyExpensesTotal + fixedExpensesTotal;
            const netProfit = netSales - totalExpenses;
            const profitColor = netProfit >= 0 ? '#00ff88' : '#ff4757';
            const profitBorderColor = netProfit >= 0 ? 'rgba(0,255,136,0.3)' : 'rgba(255,71,87,0.3)';
            const commissionData = calculateCommission(monthOrders);

            // تحميل تعديلات العمولات المحفوظة
            const commissionAdjustments = JSON.parse(localStorage.getItem('commissionAdjustments') || '{}');

            document.getElementById('monthlyReportContent').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card"><i class="fas fa-money-bill-wave stat-icon"></i><div class="stat-value">${formatNumber(grossSales)}</div><div class="stat-label">إجمالي المبيعات (جنيه)</div><small style="color: #00ff88;">نقدي: ${formatNumber(cashSales)}</small><br><small style="color: #00d4ff;">بنكك: ${formatNumber(bankSales)}</small></div>
                    <div class="stat-card" style="border-color: rgba(255,170,0,0.3);"><i class="fas fa-tags stat-icon" style="color: #ffaa00;"></i><div class="stat-value" style="color: #ffaa00;">${formatNumber(totalDiscount)}</div><div class="stat-label">إجمالي الخصومات (جنيه)</div></div>
                    <div class="stat-card" style="border-color: rgba(0,255,136,0.3);"><i class="fas fa-hand-holding-usd stat-icon" style="color: #00ff88;"></i><div class="stat-value" style="color: #00ff88;">${formatNumber(netSales)}</div><div class="stat-label">صافي المبيعات (جنيه)</div></div>
                    <div class="stat-card"><i class="fas fa-receipt stat-icon"></i><div class="stat-value">${monthOrders.length}</div><div class="stat-label">عدد الطلبات</div></div>
                    <div class="stat-card expense-card"><i class="fas fa-wallet stat-icon" style="color: #ffaa00;"></i><div class="stat-value" style="color: #ffaa00;">${formatNumber(totalExpenses)}</div><div class="stat-label">إجمالي المصروفات</div><small style="color: #ffaa00;">يومية: ${formatNumber(dailyExpensesTotal)}</small><br><small style="color: #ff6600;">ثابتة: ${formatNumber(fixedExpensesTotal)}</small></div>
                    <div class="stat-card" style="border-color: ${profitBorderColor};"><i class="fas fa-chart-line stat-icon" style="color: ${profitColor};"></i><div class="stat-value" style="color: ${profitColor};">${formatNumber(netProfit)}</div><div class="stat-label">صافي الربح (جنيه)</div></div>
                </div>
                ${fixedExpenses.length > 0 ? `<div class="card" style="margin-top: 20px; background: rgba(255,102,0,0.1); border: 1px solid rgba(255,102,0,0.3);"><h4 style="color: #ff6600; margin-bottom: 15px;"><i class="fas fa-calendar-check"></i> المصروفات الثابتة الشهرية</h4><div class="table-container"><table><thead><tr><th>المصروف</th><th>المبلغ</th></tr></thead><tbody>${fixedExpenses.map(exp => `<tr><td><i class="fas fa-money-check-alt" style="color: #ff6600; margin-left: 10px;"></i>${exp.name}</td><td style="color: #ff6600;">${formatNumber(exp.amount)} جنيه</td></tr>`).join('')}<tr style="background: rgba(255,102,0,0.2);"><td><strong>إجمالي المصروفات الثابتة</strong></td><td style="color: #ff6600;"><strong>${formatNumber(fixedExpensesTotal)} جنيه</strong></td></tr></tbody></table></div></div>` : ''}

                <!-- قسم عمولات الموظفين -->
                <div class="card" style="margin-top: 20px; background: rgba(255,170,0,0.1); border: 1px solid rgba(255,170,0,0.3);">
                    <h4 style="color: #ffaa00; margin-bottom: 15px;"><i class="fas fa-user-tie"></i> عمولات الموظفين</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>الموظف</th>
                                    <th>العمولة المحسوبة</th>
                                    <th>العمولة النهائية</th>
                                    ${isAdmin() ? '<th>إجراء</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${commissionData.employees.length > 0 ? commissionData.employees.map(emp => {
                                    const adjustedAmount = commissionAdjustments[emp.name] !== undefined ? commissionAdjustments[emp.name] : emp.totalCommission;
                                    return `
                                        <tr>
                                            <td><i class="fas fa-user" style="color: #00d4ff; margin-left: 8px;"></i>${emp.name}</td>
                                            <td>${formatNumber(emp.totalCommission)} جنيه</td>
                                            <td>
                                                ${isAdmin() ?
                                                    `<input type="number" id="commission-${emp.name}" value="${adjustedAmount.toFixed(2)}"
                                                        style="width: 120px; padding: 8px; border: 2px solid #ffaa00; border-radius: 8px; background: rgba(0,0,0,0.3); color: #ffaa00; font-weight: bold; text-align: center;"
                                                        step="0.5" min="0">`
                                                    : `<span style="color: #ffaa00; font-weight: bold;">${formatNumber(adjustedAmount)} جنيه</span>`
                                                }
                                            </td>
                                            ${isAdmin() ? `<td><button class="btn btn-primary" style="padding: 8px 15px;" onclick="saveCommissionAdjustment('${emp.name}')"><i class="fas fa-save"></i> حفظ</button></td>` : ''}
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="4" style="text-align: center;">لا توجد عمولات</td></tr>'}
                            </tbody>
                            <tfoot style="background: rgba(255,170,0,0.3);">
                                <tr>
                                    <td><strong>الإجمالي</strong></td>
                                    <td><strong>${formatNumber(commissionData.total)} جنيه</strong></td>
                                    <td colspan="${isAdmin() ? '2' : '1'}"><strong style="color: #ffaa00; font-size: 1.2rem;">${formatNumber(Object.keys(commissionAdjustments).length > 0 ?
                                        commissionData.employees.reduce((sum, emp) => sum + (commissionAdjustments[emp.name] !== undefined ? commissionAdjustments[emp.name] : emp.totalCommission), 0)
                                        : commissionData.total)} جنيه</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    ${isAdmin() ? `<div style="margin-top: 15px; padding: 10px; background: rgba(0,212,255,0.1); border-radius: 8px; text-align: center;">
                        <small style="color: #00d4ff;"><i class="fas fa-info-circle"></i> يمكنك تعديل قيمة العمولة النهائية لكل موظف ثم الضغط على حفظ</small>
                    </div>` : ''}
                </div>`;
        }

        // حفظ تعديل العمولة
        function saveCommissionAdjustment(employeeName) {
            const input = document.getElementById(`commission-${employeeName}`);
            if (!input) return;
            const newAmount = parseFloat(input.value) || 0;
            const adjustments = JSON.parse(localStorage.getItem('commissionAdjustments') || '{}');
            adjustments[employeeName] = newAmount;
            localStorage.setItem('commissionAdjustments', JSON.stringify(adjustments));
            showAlert(`تم حفظ عمولة ${employeeName}: ${newAmount.toFixed(2)} جنيه`, 'success');
            loadMonthlyReport();
        }

        async function loadServicesReport() {
            const mockOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
            const serviceStats = {};
            mockOrders.forEach(order => {
                if (!order.items) return;

                // حساب إجمالي الفاتورة قبل الخصم الإضافي لتوزيع الخصم بالتناسب
                let orderSubtotal = 0;
                order.items.forEach(item => {
                    let itemGross = item.price * item.quantity;
                    let itemNet = itemGross;
                    if (item.customPrice !== undefined && item.customPrice < item.price) {
                        itemNet = item.customPrice * item.quantity;
                    } else if (item.hasDiscount && item.quantity >= item.discountQty) {
                        itemNet = itemGross - (itemGross * (item.discountPercent / 100));
                    }
                    orderSubtotal += itemNet;
                });

                // نسبة الخصم الإضافي من الفاتورة
                const orderDiscountAmount = order.discountAmount || 0;
                const discountRatio = orderSubtotal > 0 ? orderDiscountAmount / orderSubtotal : 0;

                order.items.forEach(item => {
                    if (!serviceStats[item.name]) serviceStats[item.name] = { count: 0, grossRevenue: 0, discount: 0, netRevenue: 0 };
                    serviceStats[item.name].count += item.quantity;
                    const grossTotal = item.price * item.quantity;
                    serviceStats[item.name].grossRevenue += grossTotal;

                    // حساب خصم الكمية أو السعر المخصص
                    let itemDiscount = 0;
                    let itemNetBeforeOrderDiscount = grossTotal;
                    if (item.customPrice !== undefined && item.customPrice < item.price) {
                        itemDiscount = (item.price - item.customPrice) * item.quantity;
                        itemNetBeforeOrderDiscount = item.customPrice * item.quantity;
                    } else if (item.hasDiscount && item.quantity >= item.discountQty) {
                        itemDiscount = grossTotal * (item.discountPercent / 100);
                        itemNetBeforeOrderDiscount = grossTotal - itemDiscount;
                    }

                    // توزيع خصم الفاتورة الإضافي على هذه الخدمة بالتناسب
                    const itemDiscountFromOrder = itemNetBeforeOrderDiscount * discountRatio;
                    const totalItemDiscount = itemDiscount + itemDiscountFromOrder;
                    const finalItemNet = grossTotal - totalItemDiscount;

                    serviceStats[item.name].discount += totalItemDiscount;
                    serviceStats[item.name].netRevenue += finalItemNet;
                });
            });
            const sortedServices = Object.entries(serviceStats).sort((a, b) => b[1].netRevenue - a[1].netRevenue);
            const totalGross = sortedServices.reduce((sum, [_, s]) => sum + s.grossRevenue, 0);
            const totalDiscount = sortedServices.reduce((sum, [_, s]) => sum + s.discount, 0);
            const totalNet = sortedServices.reduce((sum, [_, s]) => sum + s.netRevenue, 0);
            document.getElementById('servicesReportContent').innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>الخدمة</th>
                                <th>عدد المبيعات</th>
                                <th>الإيرادات</th>
                                <th style="color: #ffaa00;">قيمة الخصم</th>
                                <th style="color: #00ff88;">الصافي</th>
                                ${isAdmin() ? '<th>إجراء</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedServices.map(([name, stats]) => `
                                <tr>
                                    <td>${name}</td>
                                    <td>${stats.count}</td>
                                    <td>${formatNumber(stats.grossRevenue)} جنيه</td>
                                    <td style="color: #ffaa00;">${formatNumber(stats.discount)} جنيه</td>
                                    <td style="color: #00ff88; font-weight: bold;">${formatNumber(stats.netRevenue)} جنيه</td>
                                    ${isAdmin() ? `<td><button class="btn btn-danger" style="padding: 5px 10px;" onclick="showDeleteServiceRevenueModal('${name}')"><i class="fas fa-trash"></i> حذف</button></td>` : ''}
                                </tr>
                            `).join('') || `<tr><td colspan="${isAdmin() ? 6 : 5}" style="text-align: center;">لا توجد بيانات</td></tr>`}
                        </tbody>
                        <tfoot style="background: rgba(0,212,255,0.2); font-weight: bold;">
                            <tr>
                                <td>الإجمالي</td>
                                <td>-</td>
                                <td>${formatNumber(totalGross)} جنيه</td>
                                <td style="color: #ffaa00;">${formatNumber(totalDiscount)} جنيه</td>
                                <td style="color: #00ff88;">${formatNumber(totalNet)} جنيه</td>
                                ${isAdmin() ? '<td></td>' : ''}
                            </tr>
                        </tfoot>
                    </table>
                </div>`;
        }

        // حذف إيرادات خدمة معينة
        function showDeleteServiceRevenueModal(serviceName) {
            const mockOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
            // البحث عن الطلبات التي تحتوي على هذه الخدمة
            const ordersWithService = mockOrders.filter(o => o.items && o.items.some(i => i.name === serviceName));

            if (ordersWithService.length === 0) {
                showAlert('لا توجد طلبات تحتوي على هذه الخدمة', 'error');
                return;
            }

            let html = `
                <div class="modal active" id="deleteServiceRevenueModal" style="z-index: 2000;">
                    <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 15px; color: #ff4757;"><i class="fas fa-trash"></i> حذف إيرادات: ${serviceName}</h3>
                        <p style="margin-bottom: 15px;">اختر الطلبات التي تريد حذفها (تحتوي على ${serviceName}):</p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllOrders" onchange="toggleSelectAllOrders()"></th>
                                        <th>رقم الطلب</th>
                                        <th>العميل</th>
                                        <th>التاريخ</th>
                                        <th>الكمية</th>
                                        <th>المبلغ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ordersWithService.map(order => {
                                        const serviceItem = order.items.find(i => i.name === serviceName);
                                        const itemTotal = (serviceItem.customPrice !== undefined ? serviceItem.customPrice : serviceItem.price) * serviceItem.quantity;
                                        return `
                                            <tr>
                                                <td><input type="checkbox" class="order-checkbox" value="${order.id}"></td>
                                                <td>#${order.id}</td>
                                                <td>${order.customerName}</td>
                                                <td>${formatDate(order.date)}</td>
                                                <td>${serviceItem.quantity}</td>
                                                <td>${formatNumber(itemTotal)} جنيه</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-danger" onclick="deleteSelectedServiceRevenue('${serviceName}')"><i class="fas fa-trash"></i> حذف المحدد</button>
                            <button class="btn btn-secondary" onclick="closeModal('deleteServiceRevenueModal')"><i class="fas fa-times"></i> إلغاء</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function toggleSelectAllOrders() {
            const selectAll = document.getElementById('selectAllOrders').checked;
            document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = selectAll);
        }

        function deleteSelectedServiceRevenue(serviceName) {
            const selectedIds = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => parseInt(cb.value));
            if (selectedIds.length === 0) {
                showAlert('يرجى اختيار طلب واحد على الأقل', 'error');
                return;
            }
            if (!confirm(`هل أنت متأكد من حذف ${selectedIds.length} طلب؟`)) return;

            let mockOrders = JSON.parse(localStorage.getItem('mockOrders') || '[]');
            mockOrders = mockOrders.filter(o => !selectedIds.includes(o.id));
            localStorage.setItem('mockOrders', JSON.stringify(mockOrders));

            // حذف من Google Sheets أيضاً
            selectedIds.forEach(id => apiCall('deleteOrder', { id }));

            closeModal('deleteServiceRevenueModal');
            showAlert(`تم حذف ${selectedIds.length} طلب بنجاح`, 'success');
            loadServicesReport();
            loadDashboard();
        }

        // ============ Settings ============
        function loadShopInfo() { document.getElementById('shopName').value = shopInfo.name || ''; document.getElementById('shopPhone').value = shopInfo.phone || ''; document.getElementById('shopAddress').value = shopInfo.address || ''; document.getElementById('shopTaxNumber').value = shopInfo.taxNumber || ''; }

        function saveShopInfo() { shopInfo = { name: document.getElementById('shopName').value, phone: document.getElementById('shopPhone').value, address: document.getElementById('shopAddress').value, taxNumber: document.getElementById('shopTaxNumber').value }; localStorage.setItem('shopInfo_mustaqbal', JSON.stringify(shopInfo)); showAlert('تم حفظ معلومات المحل!', 'success'); }

        function renderServicesSettings() {
            document.getElementById('servicesSettings').innerHTML = `<div class="table-container"><table><thead><tr><th>الخدمة</th><th>السعر</th><th>خصم الكمية</th><th>نسبة الموظف</th><th>إجراءات</th></tr></thead><tbody>${services.map(s => `<tr><td><i class="fas ${s.icon}"></i> ${s.name}</td><td><input type="number" step="0.5" value="${s.price}" style="width: 80px; padding: 5px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff;" onchange="updateServicePrice(${s.id}, this.value)"> جنيه</td><td>${s.hasDiscount ? `${s.discountPercent}% (${s.discountQty}+)` : '-'}</td><td>${s.hasCommission ? `<span style="color: #ffaa00;">${s.commissionPercent}%</span>` : '-'}</td><td><button class="btn btn-secondary" style="padding: 5px 10px; margin-left: 5px;" onclick="showEditServiceModal(${s.id})"><i class="fas fa-edit"></i></button><button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteService(${s.id})"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody></table></div>`;
        }

        async function updateServicePrice(id, newPrice) { const service = services.find(s => s.id === id); if (service) { service.price = parseFloat(newPrice) || 0; await autoSaveServices(); showAlert('تم تحديث السعر!', 'success'); } }

        async function deleteService(id) { if (confirm('هل أنت متأكد من حذف هذه الخدمة؟')) { services = services.filter(s => s.id !== id); await autoSaveServices(); renderServicesSettings(); renderServices(); showAlert('تم حذف الخدمة!', 'success'); } }

        function showAddServiceModal() { document.getElementById('addServiceModal').classList.add('active'); }

        function showEditServiceModal(id) {
            const service = services.find(s => s.id === id);
            if (!service) return;
            document.getElementById('editServiceId').value = service.id;
            document.getElementById('editServiceName').value = service.name;
            document.getElementById('editServicePrice').value = service.price;
            document.getElementById('editServiceHasDiscount').checked = service.hasDiscount;
            document.getElementById('editDiscountSettings').style.display = service.hasDiscount ? 'block' : 'none';
            document.getElementById('editDiscountQty').value = service.discountQty || 100;
            document.getElementById('editDiscountPercent').value = service.discountPercent || 10;
            document.getElementById('editServiceHasCommission').checked = service.hasCommission;
            document.getElementById('editCommissionSettings').style.display = service.hasCommission ? 'block' : 'none';
            document.getElementById('editCommissionPercent').value = service.commissionPercent || 5;
            document.getElementById('editServiceModal').classList.add('active');
        }

        async function saveServiceEdit() {
            const id = parseInt(document.getElementById('editServiceId').value);
            const service = services.find(s => s.id === id);
            if (!service) return;
            service.name = document.getElementById('editServiceName').value.trim();
            service.price = parseFloat(document.getElementById('editServicePrice').value) || 0;
            service.hasDiscount = document.getElementById('editServiceHasDiscount').checked;
            service.discountQty = parseInt(document.getElementById('editDiscountQty').value) || 100;
            service.discountPercent = parseInt(document.getElementById('editDiscountPercent').value) || 10;
            service.hasCommission = document.getElementById('editServiceHasCommission').checked;
            service.commissionPercent = parseInt(document.getElementById('editCommissionPercent').value) || 5;
            await autoSaveServices();
            closeModal('editServiceModal');
            renderServicesSettings();
            renderServices();
            showAlert('تم تحديث الخدمة بنجاح!', 'success');
        }

        async function addService() {
            try {
                const name = document.getElementById('modalServiceName').value.trim();
                const price = parseFloat(document.getElementById('modalServicePrice').value) || 0;
                const icon = document.getElementById('modalServiceIcon').value;
                const hasDiscount = document.getElementById('modalServiceHasDiscount').checked;
                const discountQty = parseInt(document.getElementById('modalDiscountQty').value) || 100;
                const discountPercent = parseInt(document.getElementById('modalDiscountPercent').value) || 10;
                const hasCommission = document.getElementById('modalServiceHasCommission').checked;
                const commissionPercent = parseInt(document.getElementById('modalCommissionPercent').value) || 5;
                if (!name) { showAlert('يرجى إدخال اسم الخدمة', 'error'); return; }
                const newService = { id: Date.now(), name, price, icon, hasDiscount, discountQty, discountPercent, hasCommission, commissionPercent };
                services.push(newService);
                localStorage.setItem('services', JSON.stringify(services));
                closeModal('addServiceModal');
                renderServicesSettings();
                renderServices();
                showAlert('تم إضافة الخدمة: ' + name, 'success');
                document.getElementById('modalServiceName').value = '';
                document.getElementById('modalServicePrice').value = '';
                document.getElementById('modalServiceHasCommission').checked = false;
                document.getElementById('commissionSettings').style.display = 'none';
                // Save to cloud in background
                apiCall('saveServices', { services: services }).catch(e => console.log('Cloud save error:', e));
            } catch (error) {
                console.error('Error adding service:', error);
                showAlert('خطأ: ' + error.message, 'error');
            }
        }

        async function syncServicesToCloud() {
            await apiCall('saveServices', { services: services });
            showAlert('تم حفظ الخدمات في Google Sheets!', 'success');
        }

        // ============ Employee Management ============
        function renderEmployeesSettings() {
            const container = document.getElementById('employeesSettings');
            if (employees.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.6);">لا يوجد موظفين مسجلين</p>';
                return;
            }
            container.innerHTML = `<div class="table-container"><table><thead><tr><th>اسم الموظف</th><th>إجراءات</th></tr></thead><tbody>${employees.map((emp, index) => `<tr><td><i class="fas fa-user" style="color: #00d4ff; margin-left: 10px;"></i>${emp}</td><td><button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteEmployee(${index})"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody></table></div>`;
        }

        function loadEmployeesDropdown() {
            const select = document.getElementById('employeeName');
            select.innerHTML = '<option value="">-- اختر الموظف --</option>';
            employees.forEach(emp => select.innerHTML += `<option value="${emp}">${emp}</option>`);
        }

        async function addEmployee() {
            const name = document.getElementById('newEmployeeName').value.trim();
            if (!name) { showAlert('يرجى إدخال اسم الموظف', 'error'); return; }
            if (employees.includes(name)) { showAlert('الموظف موجود مسبقاً', 'error'); return; }
            employees.push(name);
            await autoSaveEmployees();
            document.getElementById('newEmployeeName').value = '';
            renderEmployeesSettings();
            loadEmployeesDropdown();
            showAlert('تم إضافة الموظف بنجاح!', 'success');
        }

        async function deleteEmployee(index) {
            if (confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
                employees.splice(index, 1);
                await autoSaveEmployees();
                renderEmployeesSettings();
                loadEmployeesDropdown();
                showAlert('تم حذف الموظف!', 'success');
            }
        }

        // ============ Fixed Monthly Expenses ============
        function renderFixedExpensesSettings() {
            const container = document.getElementById('fixedExpensesSettings');
            if (fixedExpenses.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.6);">لا توجد مصروفات ثابتة مسجلة</p>';
                return;
            }
            const total = fixedExpenses.reduce((sum, e) => sum + e.amount, 0);
            container.innerHTML = `<div class="table-container"><table><thead><tr><th>المصروف</th><th>المبلغ الشهري</th><th>إجراءات</th></tr></thead><tbody>${fixedExpenses.map((exp, index) => `<tr><td><i class="fas fa-money-check-alt" style="color: #ffaa00; margin-left: 10px;"></i>${exp.name}</td><td style="color: #ffaa00;">${exp.amount.toFixed(2)} جنيه</td><td><button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteFixedExpense(${index})"><i class="fas fa-trash"></i></button></td></tr>`).join('')}<tr style="background: rgba(255,170,0,0.2);"><td><strong>الإجمالي الشهري</strong></td><td style="color: #ffaa00;"><strong>${total.toFixed(2)} جنيه</strong></td><td></td></tr></tbody></table></div>`;
        }

        async function addFixedExpense() {
            const name = document.getElementById('newFixedExpenseName').value.trim();
            const amount = parseFloat(document.getElementById('newFixedExpenseAmount').value) || 0;
            if (!name || !amount) { showAlert('يرجى إدخال اسم المصروف والمبلغ', 'error'); return; }
            fixedExpenses.push({ id: Date.now(), name, amount });
            await autoSaveFixedExpenses();
            document.getElementById('newFixedExpenseName').value = '';
            document.getElementById('newFixedExpenseAmount').value = '';
            renderFixedExpensesSettings();
            showAlert('تم إضافة المصروف الثابت بنجاح!', 'success');
        }

        async function deleteFixedExpense(index) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف الثابت؟')) {
                fixedExpenses.splice(index, 1);
                await autoSaveFixedExpenses();
                renderFixedExpensesSettings();
                showAlert('تم حذف المصروف الثابت!', 'success');
            }
        }

        // ============ User Management ============
        function renderUsersTable() { document.getElementById('usersTable').innerHTML = users.map(user => `<tr><td>${user.username}</td><td>${user.fullName}</td><td><span class="role-badge ${user.role === 'admin' ? 'role-admin' : 'role-accountant'}">${user.role === 'admin' ? 'مدير' : 'محاسب'}</span></td><td>${user.id !== 1 ? `<button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteUser(${user.id})"><i class="fas fa-trash"></i></button>` : '<span style="color: rgba(255,255,255,0.5);">محمي</span>'}</td></tr>`).join(''); }

        function showAddUserModal() { document.getElementById('addUserModal').classList.add('active'); }

        async function addUser() {
            try {
                const username = document.getElementById('modalUsername').value.trim();
                const fullName = document.getElementById('modalUserFullName').value.trim();
                const password = document.getElementById('modalUserPassword').value;
                const role = document.getElementById('modalUserRole').value;
                if (!username || !fullName || !password) { showAlert('يرجى ملء جميع الحقول', 'error'); return; }
                if (users.find(u => u.username === username)) { showAlert('اسم المستخدم موجود مسبقاً', 'error'); return; }
                const newUser = { id: Date.now(), username, fullName, password, role };
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                closeModal('addUserModal');
                renderUsersTable();
                showAlert('تم إضافة المستخدم: ' + fullName, 'success');
                document.getElementById('modalUsername').value = '';
                document.getElementById('modalUserFullName').value = '';
                document.getElementById('modalUserPassword').value = '';
                // Save to cloud in background
                apiCall('saveUsers', { users: users }).catch(e => console.log('Cloud save error:', e));
            } catch (error) {
                console.error('Error adding user:', error);
                showAlert('خطأ: ' + error.message, 'error');
            }
        }

        async function deleteUser(id) {
            if (id === 1) { showAlert('لا يمكن حذف المدير الرئيسي', 'error'); return; }
            if (confirm('حذف هذا المستخدم؟')) {
                users = users.filter(u => u.id !== id);
                localStorage.setItem('users', JSON.stringify(users));
                await autoSaveUsers();
                renderUsersTable();
                showAlert('تم حذف المستخدم!', 'success');
            }
        }

        async function autoSaveUsers() {
            localStorage.setItem('users', JSON.stringify(users));
            try {
                await apiCall('saveUsers', { users: users });
            } catch (error) {
                console.error('Error saving users to cloud:', error);
            }
        }

        function exportData() {
            const data = { orders: JSON.parse(localStorage.getItem('mockOrders') || '[]'), customers: JSON.parse(localStorage.getItem('mockCustomers') || '[]'), inventory: JSON.parse(localStorage.getItem('mockInventory') || '[]'), expenses: JSON.parse(localStorage.getItem('mockExpenses') || '[]'), services, shopInfo, users };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `print-shop-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
            showAlert('تم تصدير البيانات!', 'success');
        }

        function confirmClearData() { if (confirm('مسح جميع البيانات؟')) { if (confirm('تأكيد أخير!')) { localStorage.removeItem('mockOrders'); localStorage.removeItem('mockCustomers'); localStorage.removeItem('mockInventory'); localStorage.removeItem('mockExpenses'); showAlert('تم مسح البيانات!', 'success'); loadDashboard(); } } }

        // ============ Utilities ============
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function formatDate(dateString) { return new Date(dateString).toLocaleDateString('ar-SA', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
        function showAlert(message, type) { const div = document.createElement('div'); div.className = `alert alert-${type}`; div.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;'; div.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'times-circle'}"></i> ${message}`; document.body.appendChild(div); setTimeout(() => { div.style.opacity = '0'; div.style.transition = 'opacity 0.3s'; setTimeout(() => div.remove(), 300); }, 3000); }
        document.querySelectorAll('.modal').forEach(modal => { modal.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('active'); }); });
    </script>
</body>
</html>
